---
title: Определение блоков __asm как макросов C
ms.date: 08/30/2018
helpviewer_keywords:
- macros, __asm blocks
- Visual C, macros
- __asm keyword [C++], as C macros
ms.assetid: 677ba11c-21c8-4609-bba7-cd47312243b0
ms.openlocfilehash: 4195624078c53f6c1f20cd2a03ed53dac937d9cd
ms.sourcegitcommit: 1f009ab0f2cc4a177f2d1353d5a38f164612bdb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/27/2020
ms.locfileid: "87192110"
---
# <a name="defining-__asm-blocks-as-c-macros"></a>Определение блоков __asm как макросов C

**Блок, относящийся только к системам Microsoft**

Макросы C предоставляют удобный способ вставки кода сборки в исходный код, но они требуют особой осторожности. поскольку макрос расширяется в одну логическую строку. Для создания безотказных макросов следуйте правилам ниже.

- Заключите **`__asm`** блок в фигурные скобки.

- Вставьте **`__asm`** ключевое слово перед каждой инструкцией сборки.

- Используйте комментарии на языке C старого стиля (`/* comment */`) вместо комментариев в стиле сборки (`; comment`) или однострочных комментариев С (`// comment`).

Чтобы проиллюстрировать вышесказанное, в следующем примере определяется простой макрос.

```cpp
#define PORTIO __asm      \
/* Port output */         \
{                         \
   __asm mov al, 2        \
   __asm mov dx, 0xD007   \
   __asm out dx, al       \
}
```

На первый взгляд последние три **`__asm`** ключевых слова кажутся излишними. Однако они нужны, поскольку макрос развертывается в одну строку.

```cpp
__asm /* Port output */ { __asm mov al, 2  __asm mov dx, 0xD007 __asm out dx, al }
```

Третье и четвертое **`__asm`** Ключевые слова необходимы в качестве разделителей операторов. Единственными разделителями инструкций, распознаваемыми в **`__asm`** блоках, являются символ новой строки и **`__asm`** ключевое слово. Поскольку блок, определенный как макрос, является одной логической линией, каждую инструкцию необходимо разделить на **`__asm`** .

Очень важно использовать фигурные скобки. Если опустить их, компилятор может перепутать операторы С и C++ на одной строке справа от вызова макроса. Без закрывающей скобки компилятор не может определить, где останавливается код сборки, и вывидит инструкции C или C++ после **`__asm`** блока в качестве инструкций сборки.

Комментарии в стиле сборки, начинающиеся с точки с запятой (**;**), продолжаются до конца строки. Это вызывает проблемы с макросами, поскольку компилятор игнорирует все после комментария вплоть до конца логической строки. То же самое можно сказать об однострочных комментариях C или C++ (`// comment`). Чтобы предотвратить ошибки, используйте комментарии в формате C ( `/* comment */` ) в **`__asm`** блоках, определенных как макросы.

**`__asm`** Блок, написанный как макрос C, может принимать аргументы. Однако в отличие от обычного макроса C **`__asm`** макрос не может возвращать значение. Невозможно использовать такие макросы в выражениях С или С++.

Следует с особой тщательностью вызывать макросы этого типа. Например, вызов макроса языка сборки в функции, объявленной с помощью соглашения, **`__fastcall`** может привести к непредвиденным результатам. (См. раздел [использование и сохранение регистров во](../../assembler/inline/using-and-preserving-registers-in-inline-assembly.md)встроенной сборке.)

**Завершение блока, относящегося только к системам Майкрософт**

## <a name="see-also"></a>См. также

[Встроенный ассемблер](../../assembler/inline/inline-assembler.md)<br/>
