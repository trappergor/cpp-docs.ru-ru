---
title: Элементы управления ActiveX в Интернете
ms.date: 09/12/2018
helpviewer_keywords:
- ActiveX controls [MFC], creating
- ActiveX controls [MFC], Internet
- downloading data with ActiveX controls
- OLE controls [MFC], upgrading to ActiveX
- Internet applications [MFC], ActiveX controls
- networks [MFC], downloading with ActiveX controls
ms.assetid: 7ab943c8-2022-41df-9065-d629b616eeec
ms.openlocfilehash: f06a6f6f71e922163fd95c59836c50b88b05ed3a
ms.sourcegitcommit: c21b05042debc97d14875e019ee9d698691ffc0b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/09/2020
ms.locfileid: "84616480"
---
# <a name="activex-controls-on-the-internet"></a>Элементы управления ActiveX в Интернете

Элементы управления ActiveX — это обновленная версия спецификации элемента управления OLE.

>[!IMPORTANT]
> ActiveX — это устаревшая технология, которую не следует использовать для новой разработки. Дополнительные сведения см. в разделе [элементы управления ActiveX](activex-controls.md).

Элементы управления — это основная архитектура для разработки программируемых программных компонентов, которые могут использоваться в различных контейнерах, включая веб-браузеры, поддерживающие COM в Интернете. Любой элемент управления ActiveX может быть Интернет-элементом управления и может добавлять его функциональные возможности в активный документ или в состав страницы. Элементы управления на веб-странице могут взаимодействовать друг с другом с помощью сценариев.

Элементы управления ActiveX не ограничиваются Интернетом. Элемент управления ActiveX можно также использовать в любом контейнере, если элемент управления поддерживает интерфейсы, необходимые для этого контейнера.

**Элементы управления ActiveX имеют несколько преимуществ, в том числе:**

- Меньше требуемых интерфейсов, чем предыдущие элементы управления OLE.

- Возможность работать без окон и всегда активна на месте.

**Чтобы быть элементом управления ActiveX, элемент управления должен:**

- Поддержка `IUnknown` интерфейса.

- Быть COM-объектом.

- Экспортируйте **DLLRegisterServer** и **DLLUnRegisterServer**.

- Поддержка дополнительных интерфейсов, необходимых для функционирования.

## <a name="making-your-existing-controls-internet-friendly"></a>Как сделать существующие элементы управления удобными в Интернете

Разработка элемента управления, который хорошо работает в среде Интернета, требует относительно низкой скорости передачи данных в Интернете. Можно использовать существующие элементы управления. Однако необходимо выполнить ряд действий, чтобы уменьшить размер кода и сделать свойства элемента управления асинхронно загружаемыми.

Чтобы повысить производительность элементов управления, следуйте приведенным ниже советам по вопросам повышения эффективности.

- Реализуйте методы, описанные в статье [элементы управления ActiveX: оптимизация](mfc-activex-controls-optimization.md).

- Рассмотрим, как создается экземпляр элемента управления.

- Быть асинхронным; не держите другие программы.

- Загрузка данных в небольшие блоки.

   При загрузке больших потоков, таких как точечные рисунки или видеоданные, осуществляется асинхронный доступ к данным элемента управления во время взаимодействия с контейнером. Извлеките данные в добавочной или прогрессивной манере, работая совместно с другими элементами управления, которые могут также получать данные. Код также можно скачать асинхронно.

- Скачайте код и свойства в фоновом режиме.

- Как можно быстрее становится активным пользовательский интерфейс.

- Оцените, как хранятся постоянные данные, как свойства, так и большие двоичные объекты данных (например, Растровое изображение или видеоданные).

   Элементы управления с значительными объемами постоянных данных, таких как крупные точечные рисунки или файлы AVI, требуют тщательного внимания при скачивании метода. Документ или страница могут стать видимыми как можно скорее, а также позволить пользователю взаимодействовать со страницей, пока элементы управления получают данные в фоновом режиме.

- Напишите эффективные подпрограммы для сохранения размера кода и времени выполнения.

   Небольшие элементы управления "Кнопка" и "метка", за исключением нескольких байтов постоянных данных, подходят для использования в среде Интернета и хорошо работают в браузерах.

- Рассмотрите возможность передачи сведений о ходе выполнения в контейнер.

   Уведомлять контейнер о ходе выполнения асинхронной загрузки, включая время, когда пользователь может начать взаимодействие со страницей, и по завершении загрузки. Контейнер может отображать ход выполнения (например, процент завершения) для пользователя.

- Оцените, как элементы управления регистрируются на клиентском компьютере.

## <a name="creating-a-new-activex-control"></a>Создание нового элемента управления ActiveX

При создании нового элемента управления с помощью мастера приложений можно включить поддержку асинхронных моникеров и других оптимизаций. Чтобы добавить поддержку свойств элемента управления для загрузки в асинхронном режиме, выполните следующие действия.

#### <a name="to-create-your-project-using-the-mfc-activex-control-wizard"></a>Создание проекта с помощью мастера элементов ActiveX MFC

1. В меню **файл** выберите команду **создать** .

1. Выберите **Мастер элементов управления ActiveX MFC** в проектах Visual Studio C++ и присвойте проекту имя.

1. На странице **Параметры управления** выберите **асинхронная загрузка свойств**. При выборе этого параметра для вас настраивается свойство состояние готовности и событие готово к изменению состояния.

   Можно также выбрать другие оптимизации, такие как активация без **окон**, которая описана в разделе [элементы управления ActiveX: оптимизация](mfc-activex-controls-optimization.md).

1. Чтобы создать проект, нажмите кнопку **Готово**.

#### <a name="to-create-a-class-derived-from-cdatapathproperty"></a>Создание класса, производного от Кдатапаспроперти

1. Создайте класс, производный от `CDataPathProperty` .

1. В каждом из исходных файлов, включающих заголовочный файл элемента управления, добавьте перед ним файл заголовка для этого класса.

1. В этом классе Переопределите `OnDataAvailable` . Эта функция вызывается каждый раз, когда данные доступны для вывода. По мере того как данные станут доступны, вы можете управлять им любым способом, например путем поэтапной отрисовки.

   Приведенный ниже фрагмент кода представляет собой простой пример поэтапного отображения данных в элементе управления "поле ввода". Обратите внимание на использование флага **BSCF_FIRSTDATANOTIFICATION** для очистки элемента управления "поле ввода".

   [!code-cpp[NVC_MFCActiveXControl#1](codesnippet/cpp/activex-controls-on-the-internet_1.cpp)]

   Обратите внимание, что необходимо включить АФКСКМН. H, чтобы использовать `CListCtrl` класс.

1. При изменении общего состояния элемента управления (например, из загрузки в инициализированные или пользовательские интерактивные) необходимо вызвать метод `COleControl::InternalSetReadyState` . Если элемент управления имеет только одно свойство пути данных, можно добавить код на **BSCF_LASTDATANOTIFICATION** , чтобы уведомить контейнер о завершении скачивания. Пример.

   [!code-cpp[NVC_MFCActiveXControl#2](codesnippet/cpp/activex-controls-on-the-internet_2.cpp)]

1. Переопределите метод `OnProgress`. В `OnProgress` передается число, показывающее максимальный диапазон и число, показывающее, насколько далеко в текущей загрузке. С помощью этих чисел можно отобразить состояние, например процент завершения для пользователя.

Следующая процедура добавляет свойство в элемент управления для использования только что производного класса.

#### <a name="to-add-a-property"></a>Добавление свойства

1. В **представление классов**щелкните правой кнопкой мыши интерфейс под узлом библиотеки и выберите **Добавить**, а затем — **Добавить свойство**. Запустится **Мастер добавления свойства**.

1. В **мастере добавления свойств**установите переключатель **/получить методы set/get** , введите **имя свойства**, например едитконтролтекст, и выберите тип BSTR в качестве **типа свойства**.

1. Нажмите кнопку **Готово**.

1. Объявите переменную-член `CDataPathProperty` класса, производного от, в классе элемента управления ActiveX.

   [!code-cpp[NVC_MFCActiveXControl#3](codesnippet/cpp/activex-controls-on-the-internet_3.h)]

1. Реализуйте методы `Get/Set`. Для `Get` возвращает строку. Для `Set` Загрузите свойство и вызовите `SetModifiedFlag` .

   [!code-cpp[NVC_MFCActiveXControl#4](codesnippet/cpp/activex-controls-on-the-internet_4.cpp)]

1. В [DoPropExchange](reference/colecontrol-class.md#dopropexchange)добавьте следующую строку:

   [!code-cpp[NVC_MFCActiveXControl#5](codesnippet/cpp/activex-controls-on-the-internet_5.cpp)]

1. Переопределите [ресетдата](reference/cdatapathproperty-class.md#resetdata) , чтобы уведомить свойство о необходимости сброса элемента управления, добавив следующую строку:

   [!code-cpp[NVC_MFCActiveXControl#6](codesnippet/cpp/activex-controls-on-the-internet_6.cpp)]

## <a name="deciding-whether-to-derive-from-cdatapathproperty-or-ccacheddatapathproperty"></a>Принятие решения о необходимости наследования от Кдатапаспроперти или Ккачеддатапаспроперти

В предыдущем примере описываются шаги для наследования свойства элемента управления из `CDataPathProperty` . Это хороший выбор, если вы скачиваете данные в режиме реального времени, которые часто меняются, и для которых не нужно размещать все данные, а только текущее значение. Примером является контроль биржевых котировок.

Также можно создать производный от `CCachedDataPathProperty` . В этом случае Скачанные данные кэшируются в файле памяти. Это хороший вариант, если необходимо удерживать все скачанные данные, например элемент управления, который постепенно визуализирует точечный рисунок. В этом случае класс имеет переменную-член, содержащую ваши данные:

`CMemFile m_Cache;`

В классе элемента управления ActiveX этот файл, отображенный в памяти, можно использовать в `OnDraw` для отображения данных. В `CCachedDataPathProperty` классе, производном от элемента управления ActiveX, переопределите функцию-член `OnDataAvailable` и объявите элемент управления после вызова реализации базового класса.

[!code-cpp[NVC_MFCActiveXControl#7](codesnippet/cpp/activex-controls-on-the-internet_7.cpp)]

## <a name="downloading-data-asynchronously-using-activex-controls"></a>Асинхронная загрузка данных с помощью элементов управления ActiveX

Загрузка данных по сети должна выполняться асинхронно. Преимущество этого подхода заключается в том, что если передается большой объем данных или если соединение работает слишком долго, процесс загрузки не блокирует другие процессы на клиенте.

Асинхронные моникеры предоставляют способ асинхронной загрузки данных по сети. Операция чтения для асинхронного моникера возвращается немедленно, даже если операция не была завершена.

Например, если доступно только 10 байт, а чтение вызывается асинхронно для файла 1000, Read не блокируется, но возвращается с текущим доступным 10 байт.

[Асинхронные моникеры](asynchronous-monikers-on-the-internet.md) реализуются с помощью `CAsyncMonikerFile` класса. Однако элементы управления ActiveX могут использовать `CDataPathProperty` класс, производный от `CAsyncMonikerFile` , для реализации асинхронных свойств элемента управления.

## <a name="displaying-a-control-on-a-web-page"></a>Отображение элемента управления на веб-странице

Ниже приведен пример тега объекта и атрибуты для вставки элемента управления на веб-странице.

```xml
<OBJECT
  CLASSID="clsid:FC25B780-75BE-11CF-8B01-444553540000"
  CODEBASE="/ie/download/activex/iechart.ocx"
  ID=chart1
  WIDTH=400
  HEIGHT=200
  ALIGN=center
  HSPACE=0
  VSPACE=0>
  <PARAM NAME="BackColor" value="#ffffff"/>
  <PARAM NAME="ForeColor" value="#0000ff"/>
  <PARAM NAME="url" VALUE="/ie/controls/chart/mychart.txt"/>
</OBJECT>
```

## <a name="updating-an-existing-ole-control-to-use-new-activex-control-features"></a>Обновление существующего элемента управления OLE для использования новых функций элементов управления ActiveX

Если ваш элемент управления OLE был создан с использованием версии Visual C++ до 4,2, можно выполнить действия по улучшению его производительности и улучшению его функциональности. Подробное описание этих изменений см. в разделе [элементы управления ActiveX: оптимизация](mfc-activex-controls-optimization.md).

При добавлении поддержки асинхронных свойств к существующему элементу управления необходимо самостоятельно добавить свойство состояния готовности и `ReadyStateChange` событие. В конструкторе для элемента управления добавьте:

[!code-cpp[NVC_MFCActiveXControl#8](codesnippet/cpp/activex-controls-on-the-internet_8.cpp)]

Состояние готовности будет обновляться по мере загрузки кода путем вызова [COleControl:: InternalSetReadyState](reference/colecontrol-class.md#internalsetreadystate). В одном месте можно вызвать метод `InternalSetReadyState` из `OnProgress` переопределения класса, `CDataPathProperty` производного от.

## <a name="see-also"></a>См. также раздел

[Задачи программирования для интернет-решений MFC](mfc-internet-programming-tasks.md)<br/>
[Основные сведения о программировании Интернета MFC](mfc-internet-programming-basics.md)
