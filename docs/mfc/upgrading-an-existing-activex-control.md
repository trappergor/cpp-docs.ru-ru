---
title: Обновление существующего элемента управления ActiveX
ms.date: 09/12/2018
helpviewer_keywords:
- ActiveX controls [MFC], Internet
- LPK files for Internet controls
- safe for scripting and initialization (controls)
- OLE controls [MFC], upgrading to ActiveX
- CAB files, for ActiveX controls
- Internet applications [MFC], ActiveX controls
- Internet applications [MFC], packaging code for download
- upgrading ActiveX controls
- licensing ActiveX controls
ms.assetid: 4d12ddfa-b491-4f9f-a0b7-b51458e05651
ms.openlocfilehash: 06c39240d3718f6fbaa15b46abeb8ac9132b5945
ms.sourcegitcommit: fcb48824f9ca24b1f8bd37d647a4d592de1cc925
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/15/2019
ms.locfileid: "69510860"
---
# <a name="upgrading-an-existing-activex-control"></a>Обновление существующего элемента управления ActiveX

Существующие элементы управления ActiveX (ранее — элементы управления OLE) можно использовать в Интернете без изменения. Однако может потребоваться изменить элементы управления, чтобы повысить их производительность.

> [!IMPORTANT]
> ActiveX — это устаревшая технология, которую не следует использовать для новой разработки. Дополнительные сведения о современных технологиях, которые заменяют ActiveX, см. в разделе [элементы управления ActiveX](activex-controls.md).

При использовании элемента управления на веб-странице необходимо учитывать дополнительные соображения. Файл. ocx и все вспомогательные файлы должны находиться на целевом компьютере или загружаться через Интернет. Это позволяет получить важные соображения о размере кода и времени загрузки. Файлы для загрузки можно упаковать в подписанный CAB-файл. Вы можете пометить элемент управления как надежный для создания скриптов, а также как надежный для инициализации.

Темы этой статьи:

- [Упаковка кода для загрузки](#_core_packaging_code_for_downloading)

- [Пометка элемента управления как безопасного для создания скриптов и инициализации](#_core_marking_a_control_safe_for_scripting_and_initializing)

- [Проблемы с лицензированием](#_core_licensing_issues)

- [Код подписи](#_core_signing_code)

- [Управление палитрой](#_core_managing_the_palette)

- [Уровни безопасности браузера Internet Explorer и поведение элемента управления](#_core_internet_explorer_browser_safety_levels_and_control_behavior)

Можно также добавить оптимизации, как описано в разделе [элементы управления ActiveX: Оптимизация](../mfc/mfc-activex-controls-optimization.md). Моникеры можно использовать для асинхронного скачивания свойств и больших двоичных объектов, как описано в разделе [элементы управления ActiveX в Интернете](../mfc/activex-controls-on-the-internet.md).

##  <a name="_core_packaging_code_for_downloading"></a>Упаковка кода для загрузки

Дополнительные сведения об этой теме см. в разделе [Упаковка элементов управления ActiveX](https://docs.microsoft.com//previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa751974%28v%3dvs.85%29).

### <a name="the-codebase-tag"></a>Тег CODEBASE

Элементы управления ActiveX внедряются в веб-страницы `<OBJECT>` с помощью тега. `CODEBASE` Параметр`<OBJECT>` тега указывает расположение, откуда следует скачать элемент управления. `CODEBASE`может успешно указывать на несколько различных типов файлов.

### <a name="using-the-codebase-tag-with-an-ocx-file"></a>Использование тега CODEBASE с файлом OCX

```
CODEBASE="http://example.microsoft.com/mycontrol.ocx#version=4,
    70,
    0,
    1086"
```

Это решение скачивает только OCX-файл элемента управления и требует, чтобы все вспомогательные библиотеки DLL были установлены на клиентском компьютере. Это будет работать для браузеров Internet Explorer и MFC ActiveX, созданных C++с помощью Visual, так как Internet Explorer поставляется с вспомогательными библиотеками DLL для визуальных C++ элементов управления. Если для просмотра этого элемента управления используется другой браузер, поддерживающий элементы ActiveX, это решение не будет работать.

### <a name="using-the-codebase-tag-with-an-inf-file"></a>Использование тега CODEBASE с файлом INF

```
CODEBASE="http://example.microsoft.com/trustme.inf"
```

INF-файл будет управлять установкой OCX и вспомогательными файлами. Этот метод не рекомендуется, так как невозможно подписать INF-файл (см. раздел [код подписывания](#_core_signing_code) для указателей на подписывание кода).

### <a name="using-the-codebase-tag-with-a-cab-file"></a>Использование тега CODEBASE с файлом CAB

```
CODEBASE="http://example.microsoft.com/acontrol.cab#version=1,
    2,
    0,
    0"
```

CAB-файлы — это рекомендуемый способ упаковки элементов управления ActiveX, использующих MFC. Упаковка элемента управления ActiveX MFC в CAB-файл позволяет включать INF-файл для управления установкой элемента управления ActiveX и всеми зависимыми библиотеками DLL (например, библиотеками DLL MFC). Использование CAB-файла автоматически сжимает код для ускорения загрузки. Если вы используете CAB-файл для загрузки компонентов, то быстрее подписывать весь CAB-файл по сравнению с каждым отдельным компонентом.

### <a name="creating-cab-files"></a>Создание CAB-файлов

Средства для создания CAB-файлов теперь входят в состав [пакета SDK для Windows 10](https://dev.windows.com/downloads/windows-10-sdk).

CAB-файл, на который `CODEBASE` указывает, должен содержать OCX-файл для элемента управления ActiveX и INF-файл для управления его установкой. CAB-файл создается путем указания имени управляющего файла и INF-файла. Не включайте в этот CAB-файл зависимые библиотеки DLL, которые могут уже существовать в системе. Например, библиотеки DLL MFC упаковываются в отдельный CAB-файл и на них ссылается управляющий файл INF.

Дополнительные сведения о создании CAB-файла см. в разделе [Создание CAB-файла](/windows/win32/devnotes/cabinet-api-functions).

### <a name="the-inf-file"></a>INF-файл

В следующем примере — Индии. INF перечислены вспомогательные файлы и сведения о версии, необходимые для элемента управления MFC "Индия". Обратите внимание на расположение библиотек DLL MFC — это веб-сайт корпорации Майкрософт. Mfc42. cab предоставляется и подписывается корпорацией Майкрософт.

```
Contents of spindial.inf:
[mfc42installer]
file-win32-x86=http://activex.microsoft.com/controls/vc/mfc42.cab
[Olepro32.dll] - FileVersion=5,
    0,
    4261,
    0
[Mfc42.dll] - FileVersion=6,
    0,
    8168,
    0
[Msvcrt.dll] - FileVersion=6,
    0,
    8168,
    0
```

### <a name="the-object-tag"></a>Тег \<> объекта

В следующем примере показано использование `<OBJECT>` тега для упаковки примера элемента управления MFC в Индии.

```
<OBJECT ID="Spindial1" WIDTH=100 HEIGHT=51
    CLASSID="CLSID:06889605-B8D0-101A-91F1-00608CEAD5B3"
    CODEBASE="http://example.microsoft.com/spindial.cab#Version=1,0,0,001">
<PARAM NAME="_Version" VALUE="65536">
<PARAM NAME="_ExtentX" VALUE="2646">
<PARAM NAME="_ExtentY" VALUE="1323">
<PARAM NAME="_StockProps" VALUE="0">
<PARAM NAME="NeedlePosition" VALUE="2">
</OBJECT>
```

В этом случае в формате Индии. cab будут содержаться два файла: «Индия». ocx и «Индия-. INF». Следующая команда создает CAB-файл:

```
C:\CabDevKit\cabarc.exe -s 6144 N spindial.cab spindial.ocx spindial.inf
```

`-s 6144` Параметр резервирует место в CAB-файле для подписывания кода.

### <a name="the-version-tag"></a>Тег версии

Обратите внимание, `#Version` что сведения, указанные с помощью CAB-файла, применяются к элементу управления, указанному параметром `<OBJECT>` *ClassID* тега.

В зависимости от указанной версии можно принудительно загрузить элемент управления. Полные спецификации `OBJECT` тега, включая параметр *базы кода* , см. в справочнике консорциума W3C.

##  <a name="_core_marking_a_control_safe_for_scripting_and_initializing"></a>Пометка элемента управления как безопасного для создания скриптов и инициализации

Элементы управления ActiveX, используемые на веб-страницах, должны быть помечены как надежные для написания сценариев и быть надежными для инициализации, если они в действительности являются надежными. Защищенный элемент управления не будет выполнять операции ввода-вывода диска или напрямую обращаться к памяти или регистрам компьютера.

Элементы управления могут быть помечены как надежные для создания скриптов и для безопасного выполнения инициализации с помощью реестра. Измените `DllRegisterServer` , чтобы добавить записи, аналогичные приведенным ниже, чтобы пометить элемент управления как надежный для сценариев и сохраняемости в реестре. Альтернативным методом является реализация `IObjectSafety`.

Вы определите идентификаторы GUID (глобально уникальные идентификаторы) для элемента управления, чтобы пометить его как надежный для сценариев и для сохраняемости. Элементы управления, которые могут быть безопасно включены в скрипт, будут содержать запись реестра, подобную следующей:

```
HKEY_CLASSES_ROOT\Component Categories\{7DD95801-9882-11CF-9FA9-00AA006C42C4}
```

Элементы управления, которые могут быть безопасно инициализированы из постоянных данных, помечаются как безопасные для сохранения с записью реестра следующего вида:

```
HKEY_CLASSES_ROOT\Component Categories\{7DD95802-9882-11CF-9FA9-00AA006C42C4}
```

Добавьте записи, аналогичные приведенным ниже (заменив идентификатор класса элемента управления на месте `{06889605-B8D0-101A-91F1-00608CEAD5B3}`), чтобы связать ключи со следующим идентификатором класса:

```
HKEY_CLASSES_ROOT\CLSID\{06889605-B8D0-101A-91F1-00608CEAD5B3}\Implemented Categories\{7DD95801-9882-11CF-9FA9-00AA006C42C4}
HKEY_CLASSES_ROOT\CLSID\{06889605-B8D0-101A-91F1-00608CEAD5B3}\Implemented Categories\{7DD95802-9882-11CF-9FA9-00AA006C42C4}
```

##  <a name="_core_licensing_issues"></a>Проблемы с лицензированием

Если вы хотите использовать лицензированный элемент управления на веб-странице, необходимо убедиться, что лицензионное соглашение разрешает его использование в Интернете, и создать файл пакета лицензий (LPK) для него.

Лицензированный элемент управления ActiveX не будет правильно загружаться на HTML-странице, если компьютер с браузером Internet Explorer не лицензирован для использования элемента управления. Например, если лицензированный элемент управления создан с помощью визуального C++элемента, HTML-страница, использующая элемент управления, будет правильно загружена на компьютер, на котором был создан элемент управления, но не будет загружаться на другой компьютер, если сведения о лицензировании не включены.

Чтобы использовать лицензированный элемент управления ActiveX в Internet Explorer, необходимо проверить лицензионное соглашение, чтобы убедиться, что лицензия для этого элемента управления разрешает:

- Распространяемая версия

- Использование элемента управления в Интернете

- Использование параметра codebase

Чтобы использовать лицензированный элемент управления на странице HTML на нелицензированном компьютере, необходимо создать файл пакета лицензий (LPK). Файл LPK содержит лицензии времени выполнения для лицензированных элементов управления на странице HTML. Этот файл создается через LPK_TOOL. EXE, входящий в состав пакета SDK для ActiveX.

#### <a name="to-create-an-lpk-file"></a>Создание файла LPK

1. Запустите LPK_TOOL. EXE на компьютере с лицензией на использование элемента управления.

1. В диалоговом окне **средство создания пакетов лицензий** в списке **Доступные элементы управления** выберите каждый лицензированный элемент управления ActiveX, который будет использоваться на странице HTML, и нажмите кнопку **добавить**.

1. Щелкните **сохранить & выйти** и введите имя файла LPK. Будет создан файл LPK и закрыто приложение.

#### <a name="to-embed-a-licensed-control-on-an-html-page"></a>Встраивание лицензированного элемента управления на страницу HTML

1. Измените HTML-страницу. На странице HTML вставьте \<объект > тег для объекта диспетчера лицензий перед \<любыми тегами >. Диспетчер лицензий — это элемент управления ActiveX, который устанавливается вместе с Internet Explorer. Идентификатор своего класса показан ниже. Задайте для свойства Лпкпас объекта диспетчера лицензий путь и имя файла LPK. На каждую HTML-страницу может быть только один файл LPK.

```
<OBJECT CLASSID = "clsid:5220cb21-c88d-11cf-b347-00aa00a28331">
<PARAM NAME="LPKPath" VALUE="relative URL to .LPK file">
</OBJECT>
```

1. \<Вставьте объект > тег для лицензированного элемента управления после тега License Manager.

   Например, ниже показана HTML-страница, на которой отображается элемент управления "поле с маской (Майкрософт)". Первый идентификатор класса предназначен для элемента управления диспетчера лицензий, второй идентификатор класса — для элемента управления "поле с маской". Измените теги, чтобы они указывали на относительный путь к LPK файлу, который вы создали ранее, и добавьте тег объекта, включая идентификатор класса для вашего элемента управления.

1. Если используется подключаемый модуль ActiveX для нкомпасс, вставьте атрибут embed>дляфайлаLPK.\<

   Если элемент управления может быть просмотрен в других активных браузерах (например, Netscape, использующих подключаемый модуль ActiveX нкомпасс), необходимо добавить \<синтаксис embed >, как показано ниже.

```
<OBJECT CLASSID="clsid:5220cb21-c88d-11cf-b347-00aa00a28331">
<PARAM NAME="LPKPath" VALUE="maskedit.lpk">

<EMBED SRC = "maskedit.LPK">

</OBJECT>
<OBJECT CLASSID="clsid:C932BA85-4374-101B-A56C-00AA003668DC" WIDTH=100 HEIGHT=25>
</OBJECT>
```

Дополнительные сведения о лицензировании элементов управления см [. в разделе элементы управления ActiveX: Лицензирование элемента управления](../mfc/mfc-activex-controls-licensing-an-activex-control.md)ActiveX.

##  <a name="_core_signing_code"></a>Код подписи

Подписывание кода предназначено для обнаружения источника кода и для гарантии того, что код не был изменен с момента подписания. В зависимости от настроек безопасности браузера пользователи могут получить предупреждение перед загрузкой кода. Пользователи могут доверять определенным владельцам или компаниям сертификатов. в этом случае код, подписанный этими надежными пользователями, будет скачан без предупреждения. Код имеет цифровую подпись, чтобы избежать незаконного изменения.

Убедитесь, что окончательный код подписан, чтобы элемент управления можно было автоматически скачать без отображения предупреждающих сообщений. Дополнительные сведения о том, как подписать код, см. в документации по Authenticode в пакете SDK для ActiveX и в разделе [Подписывание CAB-файла](/windows/win32/devnotes/cabinet-api-functions).

В зависимости от параметров доверия и уровня безопасности браузера может отображаться сертификат для распознавания лица или компании подписывания. Если уровень безопасности равен None или владелец сертификата подписанного элемента управления является доверенным, то сертификат не будет отображаться. Сведения о том, как параметр безопасности обозревателя определяет, загружается ли ваш элемент управления и выводится сертификат, см. в разделе [уровни безопасности браузера Internet Explorer и поведение управления](#_core_internet_explorer_browser_safety_levels_and_control_behavior) .

Код гарантии цифровых подписей не изменился с момента подписания. Хэш кода берется и внедряется в сертификат. Этот хэш в дальнейшем сравнивается с хэшем кода, полученного после скачивания кода, но до его запуска. Такие компании, как VeriSign, могут предоставлять закрытые и открытые ключи, необходимые для подписывания кода. Пакет SDK для ActiveX поставляется с MakeCert, служебной программой для создания тестовых сертификатов.

##  <a name="_core_managing_the_palette"></a>Управление палитрой

Контейнеры определяют палитру и делают ее доступной как внешнее свойство **DISPID_AMBIENT_PALETTE**. Контейнер (например, Internet Explorer) выбирает палитру, используемую всеми элементами управления ActiveX на странице для определения собственной палитры. Это предотвращает мерцание экрана и представляет собой единообразный внешний вид.

Элемент управления может переопределяться `OnAmbientPropertyChange` для получения уведомлений об изменениях в палитре.

Элемент управления может переопределить `OnGetColorSet` , чтобы он возвращал набор цветов для рисования палитры. Контейнеры используют возвращаемое значение, чтобы определить, поддерживает ли элемент управления палитру.

В соответствии с рекомендациями OCX 96 элемент управления всегда должен понимать свою палитру в фоновом режиме.

Старые контейнеры, не использующие свойство Palette, будут отсылать сообщения WM_QUERYNEWPALETTE и WM_PALETTECHANGED. Элемент управления может `OnQueryNewPalette` переопределять `OnPaletteChanged` и выполнять обработку этих сообщений.

##  <a name="_core_internet_explorer_browser_safety_levels_and_control_behavior"></a>Уровни безопасности браузера Internet Explorer и поведение элемента управления

В браузере есть параметры уровня безопасности, настраиваемые пользователем. Поскольку веб-страницы могут содержать активное содержимое, потенциально опасное для компьютера пользователя, браузеры позволяют пользователю выбрать параметры уровня безопасности. В зависимости от способа, которым браузер реализует уровни безопасности, элемент управления может быть не загружен вообще или отображать сертификат или предупреждающее сообщение, чтобы пользователь мог выбирать во время выполнения независимо от того, следует ли загружать элемент управления. Ниже перечислены действия элементов управления ActiveX, которые имеют высокий, средний и низкий уровни безопасности в Internet Explorer.

### <a name="high-safety-mode"></a>Режим высокой безопасности

- Неподписанные элементы управления не будут скачаны.

- Подписанные элементы управления будут отображать сертификат, если не является доверенным (пользователь может выбрать параметр, который всегда будет доверять коду от этого владельца сертификата).

- Только элементы управления, помеченные как надежные, будут иметь постоянные данные и (или) быть скриптами.

### <a name="medium-safety-mode"></a>Режим средней безопасности

- Элементы управления без знака будут отображать предупреждение перед загрузкой.

- Подписанные элементы управления будут отображать сертификат, если он не является доверенным.

- Элементы управления, не помеченные как надежные, будут отображать предупреждение.

### <a name="low-safety-mode"></a>Режим низкого уровня безопасности

- Элементы управления загружаются без предупреждения.

- Скрипты и сохраняемость происходят без предупреждения.

## <a name="see-also"></a>См. также

[Задачи программирования для интернет-решений MFC](../mfc/mfc-internet-programming-tasks.md)<br/>
[Основы программирования для интернет-решений MFC](../mfc/mfc-internet-programming-basics.md)<br/>
[Элементы управления ActiveX MFC. Лицензирование элемента управления ActiveX](../mfc/mfc-activex-controls-licensing-an-activex-control.md)
