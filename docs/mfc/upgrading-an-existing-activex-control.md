---
title: Обновление существующего элемента управления ActiveX
ms.date: 09/12/2018
helpviewer_keywords:
- ActiveX controls [MFC], Internet
- LPK files for Internet controls
- safe for scripting and initialization (controls)
- OLE controls [MFC], upgrading to ActiveX
- CAB files, for ActiveX controls
- Internet applications [MFC], ActiveX controls
- Internet applications [MFC], packaging code for download
- upgrading ActiveX controls
- licensing ActiveX controls
ms.assetid: 4d12ddfa-b491-4f9f-a0b7-b51458e05651
ms.openlocfilehash: 57d94a51d9dfb78dfaf3a690c43c74a2d6ab6db3
ms.sourcegitcommit: 28eae422049ac3381c6b1206664455dbb56cbfb6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66450610"
---
# <a name="upgrading-an-existing-activex-control"></a>Обновление существующего элемента управления ActiveX

Элементы управления ActiveX в существующих (ранее элементах управления OLE) может использоваться в Интернете без изменений. Тем не менее может потребоваться изменить элементы управления для повышения их производительности.

> [!IMPORTANT]
> ActiveX — это устаревшая технология, которая не следует использовать для разработки новых приложений. Дополнительные сведения о современных технологий, заменяющие ActiveX, см. в разделе [элементы управления ActiveX](activex-controls.md).

При использовании элемента управления на веб-странице, существует ряд дополнительных рекомендаций. Соответствующий файл и все вспомогательные файлы должны быть на конечном компьютере или загрузить через Интернет. В результате размер кода и важно учитывать время загрузки. Файлы для загрузки можно упаковать в подписанные CAB-файл. Можно пометить как безопасные для использования, а также как безопасный для инициализации элемента управления.

Темы этой статьи:

- [Упаковка кода для загрузки](#_core_packaging_code_for_downloading)

- [Пометка безопасный элемент управления для сценариев и инициализации](#_core_marking_a_control_safe_for_scripting_and_initializing)

- [Проблем с лицензированием](#_core_licensing_issues)

- [Подписывание кода](#_core_signing_code)

- [Управление палитры](#_core_managing_the_palette)

- [Уровни безопасности обозревателя Internet Explorer и поведение элемента управления](#_core_internet_explorer_browser_safety_levels_and_control_behavior)

Можно также добавить оптимизации, как описано в разделе [элементы управления ActiveX: Оптимизация](../mfc/mfc-activex-controls-optimization.md). Можно использовать моникеры для загрузки свойства и большие двоичные объекты асинхронно, как описано в разделе [элементы управления ActiveX в Интернете](../mfc/activex-controls-on-the-internet.md).

##  <a name="_core_packaging_code_for_downloading"></a> Упаковка кода для загрузки

Дополнительные сведения по этому вопросу см. в разделе [упаковка элементов управления ActiveX](https://docs.microsoft.com//previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa751974%28v%3dvs.85%29).

### <a name="the-codebase-tag"></a>CODEBASE тега

Внедренные элементы управления ActiveX в веб-страниц с помощью `<OBJECT>` тега. `CODEBASE` Параметр `<OBJECT>` тег указывает расположение, из которого необходимо загрузить элемент управления. `CODEBASE` может указывать на ряд различных типах файлов успешно.

### <a name="using-the-codebase-tag-with-an-ocx-file"></a>С помощью тега базы кода с файлом OCX

```
CODEBASE="http://example.microsoft.com/mycontrol.ocx#version=4,
    70,
    0,
    1086"
```

Это решение загружает соответствующий файл только для элемента управления и требует все вспомогательные библиотеки DLL, уже установлено на клиентском компьютере. Это будет работать для Internet Explorer и ActiveX в MFC элементов управления, созданных с помощью Visual C++, поскольку Internet Explorer поставляется с вспомогательные библиотеки DLL для элементов управления Visual C++. Если другой браузер, поддерживающего элемента управления ActiveX используется для просмотра этого элемента управления, это решение не будет работать.

### <a name="using-the-codebase-tag-with-an-inf-file"></a>С помощью тега базы кода с помощью INF-файла

```
CODEBASE="http://example.microsoft.com/trustme.inf"
```

INF-файл будет управлять установкой .ocx и ее вспомогательные файлы. Этот метод не рекомендуется, так как он не можете войти с INF-файлом (см. в разделе [подписывания кода](#_core_signing_code) для указателей на подписи кода).

### <a name="using-the-codebase-tag-with-a-cab-file"></a>С помощью тега базы кода с помощью CAB-файл

```
CODEBASE="http://example.microsoft.com/acontrol.cab#version=1,
    2,
    0,
    0"
```

CAB-файлы являются рекомендуемым способом упаковки элементов управления ActiveX, использующих MFC. Упаковка элемента управления MFC ActiveX в CAB-файл позволяет с INF-файлом, должно быть включено в установку элементов управления элемента управления ActiveX и все зависимые библиотеки DLL (например, библиотеки DLL MFC). С помощью CAB-файл автоматически сжимает код для более быстрой загрузки. Если вы используете CAB-файл для загрузки компонентов, происходит быстрее для подписывания всей CAB-файл, чем каждого компонента.

### <a name="creating-cab-files"></a>Создание CAB-файлов

Средства для создания CAB-файлов, теперь входит в состав [пакета SDK для Windows 10](https://dev.windows.com/downloads/windows-10-sdk).

CAB-файл, на которые указывают `CODEBASE` должен содержать соответствующий файл для элемента управления ActiveX и INF-файл для его установки. Вы создадите CAB-файл, указав имя файла элемента управления и INF-файл. Не используйте зависимые библиотеки DLL, которые могут уже существовать в системе в этот CAB-файл. Например библиотеки DLL MFC упаковываются в отдельный CAB-файл и ссылается управляющий INF-файла.

Дополнительные сведения о том, как создать CAB-файл, см. в разделе [Создание файла CAB](/windows/desktop/devnotes/cabinet-api-functions).

### <a name="the-inf-file"></a>Файл INF

Следующий пример, spindial.inf, списки вспомогательные файлы и сведения о версии требуется для MFC Spindial управления. Обратите внимание на то, что расположение библиотек DLL MFC является веб-сайта Майкрософт. Mfc42.cab предоставляется и подписаны Microsoft.

```
Contents of spindial.inf:
[mfc42installer]
file-win32-x86=http://activex.microsoft.com/controls/vc/mfc42.cab
[Olepro32.dll] - FileVersion=5,
    0,
    4261,
    0
[Mfc42.dll] - FileVersion=6,
    0,
    8168,
    0
[Msvcrt.dll] - FileVersion=6,
    0,
    8168,
    0
```

### <a name="the-object-tag"></a>\<Объект > тег

В следующем примере демонстрируется использование `<OBJECT>` тег, чтобы упаковать Образец MFC Spindial элемента управления.

```
<OBJECT ID="Spindial1" WIDTH=100 HEIGHT=51
    CLASSID="CLSID:06889605-B8D0-101A-91F1-00608CEAD5B3"
    CODEBASE="http://example.microsoft.com/spindial.cab#Version=1,0,0,001">
<PARAM NAME="_Version" VALUE="65536">
<PARAM NAME="_ExtentX" VALUE="2646">
<PARAM NAME="_ExtentY" VALUE="1323">
<PARAM NAME="_StockProps" VALUE="0">
<PARAM NAME="NeedlePosition" VALUE="2">
</OBJECT>
```

В этом случае spindial.cab будет содержать два файла, spindial.ocx и spindial.inf. Следующая команда будет создавать CAB-файл:

```
C:\CabDevKit\cabarc.exe -s 6144 N spindial.cab spindial.ocx spindial.inf
```

`-s 6144` Параметр резервирует пространство в CAB-файл для подписывания кода.

### <a name="the-version-tag"></a>Тег версии

Обратите внимание, что `#Version` сведений, указанных с помощью CAB-файл применяется для управления, указанный в *CLASSID* параметр `<OBJECT>` тега.

В зависимости от указанной версии вы можете принудительно загрузки элемента управления. Для завершения спецификации `OBJECT` включая тег *базы кода* параметр, см. в разделе W3C ссылка.

##  <a name="_core_marking_a_control_safe_for_scripting_and_initializing"></a> Пометка безопасный элемент управления для сценариев и инициализации

Элементы управления ActiveX, используемые в веб-страницы должен быть помечен как безопасный для сценариев и инициализации, если на самом деле они безопасны. Безопасный элемент управления не выполнения операций ввода-ВЫВОДА или прямой доступ к памяти или регистров машины.

Элементы управления может быть помечен как безопасный для сценариев и инициализации с помощью реестра. Изменение `DllRegisterServer` для добавления записи, аналогичные приведенному ниже, чтобы пометить элемент управления как безопасный для сценариев и постоянного хранения в реестре. Альтернативным способом является реализация `IObjectSafety`.

Идентификаторы GUID (глобально уникальные идентификаторы) будет определена вашего элемента управления пометить его как безопасный для использования в сценариях, а также для сохраняемости. Элементы управления, которые можно безопасно скрипт будет содержать запись реестра, аналогичную следующей:

```
HKEY_CLASSES_ROOT\Component Categories\{7DD95801-9882-11CF-9FA9-00AA006C42C4}
```

Элементы управления, которые можно безопасно инициализировать из постоянных данных помечены как безопасные для операций сохранения над аналогичную запись реестра:

```
HKEY_CLASSES_ROOT\Component Categories\{7DD95802-9882-11CF-9FA9-00AA006C42C4}
```

Добавьте записи следующего вида (Замена элемента управления класса идентификатор вместо `{06889605-B8D0-101A-91F1-00608CEAD5B3}`) чтобы связать ваши ключи со следующим Идентификатором класса:

```
HKEY_CLASSES_ROOT\CLSID\{06889605-B8D0-101A-91F1-00608CEAD5B3}\Implemented Categories\{7DD95801-9882-11CF-9FA9-00AA006C42C4}
HKEY_CLASSES_ROOT\CLSID\{06889605-B8D0-101A-91F1-00608CEAD5B3}\Implemented Categories\{7DD95802-9882-11CF-9FA9-00AA006C42C4}
```

##  <a name="_core_licensing_issues"></a> Проблем с лицензированием

Если вы хотите использовать лицензированный элемент управления на веб-странице, необходимо убедиться, что лицензионное соглашение позволяет его использования в Интернете и создать файл пакета лицензий (LPK) для него.

Лицензированный элемент управления ActiveX не загрузит должным образом в HTML-страницу, если на компьютере под управлением Internet Explorer не поставляется с лицензией на использование элемента управления. Например если лицензированный элемент управления был создан с помощью Visual C++, HTML-страницу, используя элемент управления будет загружаться неправильно на компьютере, где был создан элемент управления, но он не загрузит на другом компьютере, если не включены сведения о лицензировании.

Чтобы использовать лицензированный элемент управления ActiveX в Internet Explorer, необходимо проверить, лицензионное соглашение поставщика, чтобы убедиться, что для элемента управления соглашением:

- Распространяемая версия

- Использование элемента управления в Интернете

- Использование параметра базы кода

Чтобы использовать лицензированный элемент управления в HTML-страницу nonlicensed компьютера, необходимо создать файл пакета лицензий (LPK). Файл LPK содержит лицензии времени выполнения для Лицензированные элементы управления на HTML-странице. Этот файл создается с помощью LPK_TOOL. EXE-файла, который поставляется вместе с пакетом SDK ActiveX. Дополнительные сведения см. на сайте MSDN в [ https://msdn.microsoft.com ](https://msdn.microsoft.com).

#### <a name="to-create-an-lpk-file"></a>Чтобы создать файл LPK

1. Запустите LPK_TOOL. EXE-файла на компьютере, который поставляется с лицензией на использование элемента управления.

1. В **средства разработки пакета лицензий** отображаемое в диалоговом окне **доступных элементов управления** поле со списком выберите каждую лицензию управления ActiveX, который будет использоваться на HTML-страницы и нажмите кнопку **добавить**.

1. Нажмите кнопку **сохранить и выйти из** и введите имя для файла LPK. Это создаст файл LPK и закройте приложение.

#### <a name="to-embed-a-licensed-control-on-an-html-page"></a>Чтобы внедрить лицензированный элемент управления на HTML-страницы

1. Измените страницу HTML. На странице HTML, вставка \<ОБЪЕКТА > тег для объекта диспетчера лицензий перед любыми другими \<ОБЪЕКТА > теги. Диспетчер лицензий является элементом управления ActiveX, который устанавливается вместе с Internet Explorer. Ниже приведен код его класса. Присвойте свойству LPKPath объекта диспетчера лицензий путь и имя файла, LPK. Может иметь только один файл LPK на HTML-страницу.

```
<OBJECT CLASSID = "clsid:5220cb21-c88d-11cf-b347-00aa00a28331">
<PARAM NAME="LPKPath" VALUE="relative URL to .LPK file">
</OBJECT>
```

1. Вставить \<ОБЪЕКТА > тег для лицензированного элемента управления после тега License Manager.

   Например ниже приведен HTML-страницу, в котором отображается элемент управления Microsoft Masked Edit. Первый класс, имеет идентификатор для элемента управления диспетчера лицензий, второй класс — идентификатор для элемента управления Masked Edit. Изменить теги, чтобы указать относительный путь к файлу файл с расширением LPK, созданную ранее и добавьте тег object, включая идентификатор класса для элемента управления.

1. Вставить \<ВНЕДРЕНИЯ > атрибут файла LPK, если используется подключаемый модуль ActiveX с NCompass.

   Если элемент управления может быть просмотрен на другой активный включена браузеров — например, Netscape, используя подключаемый модуль ActiveX с NCompass, необходимо добавить \<ВНЕДРЕНИЯ > синтаксис, как показано ниже.

```
<OBJECT CLASSID="clsid:5220cb21-c88d-11cf-b347-00aa00a28331">
<PARAM NAME="LPKPath" VALUE="maskedit.lpk">

<EMBED SRC = "maskedit.LPK">

</OBJECT>
<OBJECT CLASSID="clsid:C932BA85-4374-101B-A56C-00AA003668DC" WIDTH=100 HEIGHT=25>
</OBJECT>
```

Дополнительные сведения о лицензирование элементов управления, см. в разделе [элементы управления ActiveX: Лицензирование элемента управления ActiveX](../mfc/mfc-activex-controls-licensing-an-activex-control.md).

##  <a name="_core_signing_code"></a> Подписывание кода

Подписывание кода предназначен для определения источника кода и гарантировать, что код не изменился с момента его подписания. В зависимости от параметров безопасности браузера пользователей может отобразиться предупреждение перед загрузкой кода. Пользователи могут начать доверять определенных владельцам сертификатов или компаний, в которых вариантов код, подписанный те доверенные загружается без предупреждения. Во избежание подмены цифровой подписи кода.

Убедитесь, что итоговый код подписан таким образом, чтобы элемент управления могут загружаться без отображения предупреждений доверия автоматически. Дополнительные сведения о подписании кода см. в документации на Authenticode в пакете SDK ActiveX и см. в разделе [подписи CAB-файл](/windows/desktop/devnotes/cabinet-api-functions).

В зависимости от отношения доверия и браузер параметры уровня безопасности сертификат может отображаться для идентификации подписи человека или компании. Если уровень безопасности имеет значение none или со знаком управления сертификат является доверенным, сертификат не отобразится. См. в разделе [уровней безопасности обозревателя Internet Explorer и поведение элемента управления](#_core_internet_explorer_browser_safety_levels_and_control_behavior) сведения о определение настройки безопасности браузера ли ваш элемент управления будет загружен и сертификат отображается.

Цифровые подписи кода гарантии не изменилась, так как он подписан. Хэш-код берется и встроенного в сертификат. Позже этот хэш сравнивается с хэш-код, затраченное после загрузки кода, но перед его выполнением. Компаниям, таким как Verisign можно указать открытые и закрытые ключи, необходимых для подписи кода. Пакет SDK ActiveX поставляется с MakeCert, служебная программа для создания проверочных сертификатов.

##  <a name="_core_managing_the_palette"></a> Управление палитры

Контейнеры определить палитры и сделать ее доступной как свойство окружения, **DISPID_AMBIENT_PALETTE**. Контейнер (например, Internet Explorer) выбирает палитру, которая используется для всех элементов управления ActiveX, на странице, чтобы определить свои собственные палитры. Это предотвращает мерцание отображения и представляет согласованного внешнего вида.

Элемент управления может переопределить `OnAmbientPropertyChange` для обработки уведомления об изменениях в палитре.

Элемент управления может переопределить `OnGetColorSet` для возвращения набора для рисования в палитре цветов. Контейнеры используют возвращаемое значение, чтобы определить, является ли элемент управления поддержкой палитры.

Согласно рекомендациям OCX 96 элемент управления должен всегда понимают, палитру в фоновом режиме.

Более старые контейнеров, которые не используют свойство окружения палитры будет отправлять сообщения WM_QUERYNEWPALETTE и WM_PALETTECHANGED. Элемент управления может переопределить `OnQueryNewPalette` и `OnPaletteChanged` для обработки этих сообщений.

##  <a name="_core_internet_explorer_browser_safety_levels_and_control_behavior"></a> Уровни безопасности обозревателя Internet Explorer и поведение элемента управления

Браузер имеет параметры для уровень безопасности, настраиваемых пользователем. Так как веб-страницы могут содержать активное содержимое, которое потенциально может повредить компьютер пользователя, браузеров позволяют пользователю выбрать параметры для уровня безопасности. Зависимости от того, обозреватель реализует уровни безопасности элемент управления не могут быть загружены вообще или отображается предупреждающее сообщение, чтобы разрешить пользователю выбрать во время выполнения, следует ли загрузить элемент управления "или" сертификата. Ниже приводится поведения элементов управления ActiveX при другом уровне высокий, средний и низкий безопасности в Internet Explorer.

### <a name="high-safety-mode"></a>Режим высокого уровня безопасности

- Неподписанные элементы управления не будут загружаться.

- Подписанные элементы управления отобразит сертификат, если недоверенные (пользователь может выбрать параметр, чтобы теперь всегда доверять код из этого владельца сертификата).

- Только элементов, помеченных как безопасные будет иметь постоянных данных и/или выполняться с помощью сценариев.

### <a name="medium-safety-mode"></a>Режим безопасности среднего размера

- Неподписанные элементы управления будет отображать предупреждение перед загрузкой.

- Подписанные элементы управления отобразит сертификат, если недоверенные.

- Элементы управления, которые не помечены как безопасные отобразится предупреждение.

### <a name="low-safety-mode"></a>В режиме низкой безопасности

- Элементы управления, загружаются без предупреждения.

- Сценарии и сохраняемости происходит без предупреждения.

## <a name="see-also"></a>См. также

[Задачи программирования для интернет-решений MFC](../mfc/mfc-internet-programming-tasks.md)<br/>
[Основы программирования для интернет-решений MFC](../mfc/mfc-internet-programming-basics.md)<br/>
[Элементы управления ActiveX MFC. Лицензирование элемента управления ActiveX](../mfc/mfc-activex-controls-licensing-an-activex-control.md)
