---
title: Оптимизация постоянства и инициализации
ms.date: 11/04/2016
helpviewer_keywords:
- MFC ActiveX controls [MFC], optimizing
- performance, ActiveX controls
- optimization, ActiveX controls
- optimizing performance, ActiveX controls
ms.assetid: e821e19e-b9eb-49ab-b719-0743420ba80b
ms.openlocfilehash: 57b98f7e2e4f9e23175b8b01c2e37ff49c499949
ms.sourcegitcommit: c21b05042debc97d14875e019ee9d698691ffc0b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/09/2020
ms.locfileid: "84624001"
---
# <a name="optimizing-persistence-and-initialization"></a>Оптимизация постоянства и инициализации

По умолчанию сохраняемость и инициализация в элементе управления обрабатываются `DoPropExchange` функцией-членом. В типичном элементе управления эта функция содержит вызовы нескольких функций **PX_** ( `PX_Color` , `PX_Font` и т. д.), по одной для каждого свойства.

Этот подход имеет преимущество в том, что одна `DoPropExchange` реализация может использоваться для инициализации, для сохранения в двоичном формате и для сохранения в формате "контейнер свойств", который используется некоторыми контейнерами. Эта одна функция предоставляет все сведения о свойствах и их значения по умолчанию в одном удобном месте.

Однако это происходит за счет повышения эффективности. Функции **PX_** получают гибкость через многоуровневые реализации, которые по своей природе менее эффективны, чем более прямые, но менее гибкие, подходы. Более того, если элемент управления передает значение по умолчанию в **PX_** функцию, это значение по умолчанию должно предоставляться каждый раз, даже если значение по умолчанию может быть необязательно использовано. Если создание значения по умолчанию является нетривиальной задачей (например, если значение получено из внешнего свойства), то дополнительные ненужные действия выполняются в тех случаях, когда значение по умолчанию не используется.

Можно повысить производительность двоичного сохранения элемента управления, переопределив функцию элемента управления `Serialize` . Реализация по умолчанию этой функции-члена вызывает `DoPropExchange` функцию. Переопределяя его, вы можете предоставить более прямую реализацию двоичного сохраняемости. Например, рассмотрим эту `DoPropExchange` функцию:

[!code-cpp[NVC_MFC_AxOpt#1](codesnippet/cpp/optimizing-persistence-and-initialization_1.cpp)]

Чтобы повысить производительность двоичного сохраняемости этого элемента управления, можно переопределить `Serialize` функцию следующим образом:

[!code-cpp[NVC_MFC_AxOpt#2](codesnippet/cpp/optimizing-persistence-and-initialization_2.cpp)]

`dwVersion`Локальную переменную можно использовать для определения версии сохраняемого или сохраняемого постоянного состояния элемента управления. Эту переменную можно использовать вместо вызова [кпропексчанже::/Version](reference/cpropexchange-class.md#getversion).

Чтобы сохранить небольшое пространство в постоянном формате для свойства **bool** (и обеспечить его совместимость с форматом, созданным `PX_Bool` ), можно сохранить свойство в виде **байта**следующим образом:

[!code-cpp[NVC_MFC_AxOpt#3](codesnippet/cpp/optimizing-persistence-and-initialization_3.cpp)]

Обратите внимание, что в случае загрузки используется временная переменная, а затем ей присваивается значение, а не приведение *m_boolProp* к ссылке на **байты** . Метод приведения приведет к изменению только одного байта *m_boolProp* , после чего оставшиеся байты не будут инициализированы.

Для того же элемента управления можно оптимизировать инициализацию элемента управления, переопределив [COleControl:: OnResetState](reference/colecontrol-class.md#onresetstate) следующим образом:

[!code-cpp[NVC_MFC_AxOpt#4](codesnippet/cpp/optimizing-persistence-and-initialization_4.cpp)]

Хотя `Serialize` `OnResetState` функция и была переопределена, `DoPropExchange` она должна оставаться неизменной, так как она по-прежнему используется для сохранения в формате контейнера свойств. Важно поддерживать все три эти функции, чтобы обеспечить единообразное управление свойствами элемента управления независимо от того, какой механизм сохраняемости использует контейнер.

## <a name="see-also"></a>См. также раздел

[Элементы ActiveX в MFC. Оптимизация](mfc-activex-controls-optimization.md)
