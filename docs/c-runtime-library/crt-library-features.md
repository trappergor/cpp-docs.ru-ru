---
title: Особенности библиотеки CRT | Документы Майкрософт
ms.custom: ''
ms.date: 08/20/2018
ms.technology:
- cpp-standard-libraries
ms.topic: conceptual
f1_keywords:
- c.runtime
dev_langs:
- C++
helpviewer_keywords:
- MSVCR71.dll
- libraries [C++], multithreaded
- library files, run-time
- LIBCMT.lib
- LIBCP.lib
- LIBCPMT.lib
- run-time libraries, C
- CRT, release versions
- MSVCP71.dll
- LIBC.lib
- libraries [C++]
- libraries [C++], run-time
- linking [C++], libraries
ms.assetid: a889fd39-807d-48f2-807f-81492612463f
author: corob-msft
ms.author: corob
ms.workload:
- cplusplus
ms.openlocfilehash: 5785d06a09c823140362fa4afc6a8b12954e5ac3
ms.sourcegitcommit: 7f3df9ff0310a4716b8136ca20deba699ca86c6c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2018
ms.locfileid: "42578164"
---
# <a name="crt-library-features"></a>Особенности библиотеки CRT

В этом разделе обсуждаются различные LIB-файлы, входящие в библиотеки времени выполнения C, а также связанные параметры компилятора и директивы препроцессора.

## <a name="c-run-time-libraries-crt"></a>Библиотеки среды выполнения C (CRT)

Библиотека времени выполнения C (CRT) является частью стандартной библиотеки C++, содержащей библиотеку C99 стандарта ISO. Библиотеки Visual C++, которые реализуют CRT, поддерживают разработку с использованием машинного кода, а также сочетания машинного и управляемого кода. Все версии библиотек CRT поддерживают разработку многопоточного кода. Большинство библиотек поддерживает как статическое связывание (для связывания библиотеки непосредственно в коде), так и динамическое связывание (для использования в коде общих библиотек DLL).

Начиная с Visual Studio 2015, был проведен рефакторинг CRT, повлекший создание новых двоичных файлов. Универсальная библиотека CRT (UCRT) содержит функции и глобальные переменные, экспортируемые стандартной библиотекой CRT C99. UCRT теперь является компонентом Windows и поставляется в составе Windows 10. Статическая библиотека, DLL-библиотека импорта и файлы заголовков для UCRT теперь входят в пакет SDK для Windows 10. При установке Visual C++ программа установки Visual Studio устанавливает набор компонентов из пакета SDK для Windows 10, необходимых для использования UCRT. Библиотеку UCRT можно использовать в любой версии Windows, поддерживаемой Visual Studio 2015 и более поздними версиями. Ее можно распространять с помощью vcredist для поддерживаемых версий Windows (кроме Windows 10). Дополнительные сведения см. в разделе [Redistributing Visual C++ Files](../ide/redistributing-visual-cpp-files.md).

В следующей таблице перечислены библиотеки, которые реализуют UCRT.

|Библиотека|Связанная DLL|Характеристики|Параметр|Директивы препроцессора|
|-------------|--------------------|---------------------|------------|-----------------------------|
|libucrt.lib|Нет|Статически связывает UCRT в коде.|**/MT**|_MT|
|libucrtd.lib|Нет|Отладочная версия UCRT для статического связывания. Нераспространяемый компонент.|**/MTd**|_DEBUG, _MT|
|ucrt.lib|ucrtbase.dll|DLL-библиотека импорта для UCRT.|**/MD**|_MT, _DLL|
|ucrtd.lib|ucrtbased.dll|DLL-библиотека импорта для отладочной версии UCRT. Нераспространяемый компонент.|**/MDd**|_DEBUG, _MT, _DLL|

Библиотека vcruntime содержит код Visual C++, определяемый реализацией CRT (такой как поддержка обработки исключений и отладки), проверки времени выполнения, сведения о типах, сведения о реализации и некоторые расширенные функции библиотеки. Эта библиотека определяется версией используемого компилятора.

В этой таблице перечислены библиотеки, которые реализуют библиотеку vcruntime.

|Библиотека|Связанная DLL|Характеристики|Параметр|Директивы препроцессора|
|-------------|--------------------|---------------------|------------|-----------------------------|
|libvcruntime.lib|Нет|Статически связанная с кодом.|**/MT**|_MT|
|libvcruntimed.lib|Нет|Отладочная версия для статического связывания. Нераспространяемый компонент.|**/MTd**|_MT, _DEBUG|
|vcruntime.lib|vcruntime\<version>.dll|DLL-библиотека импорта для vcruntime.|**/MD**|_MT, _DLL|
|vcruntimed.lib|vcruntime\<version>d.dll|DLL-библиотека импорта для отладочной версии vcruntime. Нераспространяемый компонент.|**/MDd**|_DEBUG, _MT, _DLL|

Когда произошел рефакторинг UCRT, функции среды выполнения с параллелизмом были перемещены в concrt140.dll, который является частью распространяемого пакета C++. Эта библиотека DLL необходима для параллельных контейнеров и алгоритмов C++, таких как `concurrency::parallel_for`. Кроме того, стандартная библиотека C++ требует эту библиотеку DLL в Windows XP для поддержки примитивов синхронизации, так как Windows XP не поддерживает переменные условия.

Код, инициализирующий CRT, находится в одной из нескольких библиотек в зависимости от статического или динамического связывания библиотеки CRT и использования машинного, управляемого или смешанного кода. Этот код обрабатывает запуск, инициализацию внутренних данных потоков и завершение CRT. Он определяется версией используемого компилятора. Эта библиотека всегда статически связана, даже при использовании динамически связанной библиотеки UCRT.

В этой таблице перечислены библиотеки, которые реализуют инициализацию и завершение CRT.

|Библиотека|Характеристики|Параметр|Директивы препроцессора|
|-------------|---------------------|------------|-----------------------------|
|LIBCMT.lib|Статически связывает в коде запуск CRT машинного кода.|**/MT**|_MT|
|libcmtd.lib|Статически связывает отладочную версию запуска CRT в машинном коде. Нераспространяемый компонент.|**/MTd**|_DEBUG, _MT|
|msvcrt.lib|Статическая библиотека для запуска CRT в машинном коде для использования с DLL, UCRT и vcruntime.|**/MD**|_MT, _DLL|
|msvcrtd.lib|Статическая библиотека для запуска отладочной версии CRT в машинном коде для использования с DLL, UCRT и vcruntime. Нераспространяемый компонент.|**/MDd**|_DEBUG, _MT, _DLL|
|msvcmrt.lib|Статическая библиотека для запуска CRT в смешанном машинном и управляемом коде для использования с DLL, UCRT и vcruntime.|**/clr**||
|msvcmrtd.lib|Статическая библиотека для запуска отладочной версии CRT в смешанном машинном и управляемом коде для использования с DLL, UCRT и vcruntime. Нераспространяемый компонент.|**/clr**||
|msvcurt.lib|**Нерекомендуемая** статическая библиотека для CRT с полностью управляемым кодом.|**/clr:pure**||
|msvcurtd.lib|**Нерекомендуемая** статическая библиотека для отладочной версии CRT с полностью управляемым кодом. Нераспространяемый компонент.|**/clr:pure**||

При ссылке программы из командной строки без параметра компилятора, задающего библиотеку выполнения C, компоновщик будет использовать статически связанные библиотеки CRT: libcmt.lib, libvcruntime.lib и libucrt.lib.

Использование статически скомпонованных CRT означает, что все сведения о состоянии, сохраненные библиотекой времени выполнения C, будут локальны по отношению к этому экземпляру CRT. Например, если применяется [strtok, _strtok_l, wcstok, _wcstok_l, _mbstok, _mbstok_l](../c-runtime-library/reference/strtok-strtok-l-wcstok-wcstok-l-mbstok-mbstok-l.md) при использовании статически скомпонованной CRT, позиция анализатора `strtok` не связана с состоянием `strtok`, которое используется в коде в этом же процессе (но в другом файле DLL или EXE), скомпонованном с другим экземпляром статической библиотеки CRT. Напротив, динамически скомпонованная библиотека CRT позволяет использовать состояние всему коду в процессе, который динамически скомпонован с этой библиотекой CRT. Это не относится к новым более безопасным версиям этих функций; например, эта проблема не распространяется на `strtok_s` .

Поскольку библиотека DLL, собранная путем компоновки со статической библиотекой CRT, будет иметь собственное состояние CRT, не рекомендуется использовать статическую компоновку с CRT для DLL без понимания последствий и конкретной необходимости. Например, при вызове функции [_set_se_translator](../c-runtime-library/reference/set-se-translator.md) в исполняемом файле, который загружает библиотеку DLL, скомпонованную с собственной статической библиотекой CRT, все аппаратные исключения, создаваемые в коде библиотеки DLL, не будут перехватываться транслятором, в отличие от аппаратных исключений, создаваемых в коде основного исполняемого файла.

Если используется параметр компилятора **/clr** , код будет скомпонован со статической библиотекой msvcmrt.lib. Эта статическая библиотека предоставляет функцию прокси между управляемым кодом и неуправляемой средой CRT. Невозможно использовать статически скомпонованные CRT (параметры **/MT** или **/MTd** ) с параметром **/clr**. Вместо этого используйте динамически скомпонованные библиотеки (**/MD** или **/MDd**). Полностью управляемые библиотеки CRT отмечены как нерекомендуемые для использования в Visual Studio 2015 и не поддерживаются в Visual Studio 2017.

Дополнительные сведения об использовании CRT с **/clr** см. в разделе [Смешанные (собственные и управляемые) сборки](../dotnet/mixed-native-and-managed-assemblies.md).

Для сборки отладочной версии приложения должен быть определен флаг [_DEBUG](../c-runtime-library/debug.md), и приложение должно быть скомпоновано с отладочной версией одной из этих библиотек. Дополнительные сведения об использовании отладочных версий файлов библиотек см. в разделе [Методы отладки CRT](/visualstudio/debugger/crt-debugging-techniques).

Эта версия CRT не полностью совместима со стандартом C99. В частности, заголовок \<tgmath.h> и макросы pragma CX_LIMITED_RANGE/FP_CONTRACT не поддерживаются. Некоторые элементы, такие как значения спецификаторов параметров в стандартных функциях ввода-вывода, по умолчанию используют интерпретации прежних версий. Для управления некоторыми аспектами соответствия библиотеки можно использовать параметры согласованности компилятора /Zc и задать параметры компоновщика.

## <a name="c-standard-library"></a>Стандартная библиотека C++

|Стандартная библиотека C++|Характеристики|Параметр|Директивы препроцессора|
|----------------------------|---------------------|------------|-----------------------------|
|libcpmt.lib|Многопоточная, статическая компоновка.|**/MT**|_MT|
|msvcprt.lib|Многопоточная динамическая компоновка (библиотека импорта для MSVCP*версия*.dll)|**/MD**|_MT, _DLL|
|libcpmtd.lib|Многопоточная, статическая компоновка.|**/MTd**|_DEBUG, _MT|
|msvcprtd.lib|Многопоточная динамическая компоновка (библиотека импорта для MSVCP*версия*D.DLL)|**/MDd**|_DEBUG, _MT, _DLL|

При сборке финальной версии проекта одна из базовых библиотек времени выполнения C (libcmt.lib, msvcmrt.lib, msvcrt.lib) будет скомпонована по умолчанию, в зависимости от выбранного параметра компилятора (многопоточный, DLL, /clr). Если вы включите в код любой из [файлов заголовка стандартной библиотеки C++](../standard-library/cpp-standard-library-header-files.md), Visual C++ автоматически подключит стандартную библиотеку C++ во время компиляции. Пример:

```cpp
#include <ios>
```

Для совместимости на уровне двоичного кода одна библиотека импорта может задавать несколько DLL-файлов. Обновления версий могут ввести *библиотеки dot* — отдельные DLL-файлы, которые вводят новые функции библиотеки. Например, в Visual Studio 2017 версии 15.6 появился файл msvcp140_1.dll для поддержки дополнительных функций стандартной библиотеки без нарушения ABI, поддерживаемого msvcp140.dll. Библиотека импорта msvcprt.lib, включенная в набор инструментов для Visual Studio 2017 версии 15.6, поддерживает оба DLL-файла, а vcredist для этой версии устанавливает оба DLL-файла. После доставки библиотека dot имеет фиксированный ABI и никогда не будет зависеть от библиотеки dot более поздней версии.

## <a name="what-problems-exist-if-an-application-uses-more-than-one-crt-version"></a>Если приложение использует несколько версий CRT, с какими проблемами можно столкнуться?

С каждым исполняемым образом (EXE или DLL) может статически связываться собственная библиотека CRT. В образе может создаваться динамическая ссылка на CRT. Версия CRT статически включена или динамически загружается в зависимости от версии средств и библиотек, в которой она был создана. В рамках одного процесса может загружаться несколько образов EXE и DLL, каждый с собственной библиотекой CRT. Распределители, внутренние структуры макета и варианты организации хранилища для этих CRT могут быть разными. Это означает, что выделенная память, ресурсы CRT или классы, которые передаются через границу библиотеки DLL, могут вызвать проблемы с управлением памятью, внутренним статическим использованием или интерпретацией макета. Например, если класс выделен в одной библиотеке DLL, но передан в другую и удален, какой используется метод освобождения CRT? Возникающие ошибки могут быть в диапазоне от несущественных до неустранимых. Поэтому настоятельно не рекомендуем передавать такие ресурсы напрямую.

Многих проблем можно избежать, воспользовавшись технологией двоичного интерфейса приложений (ABI). Она ориентирована на стабильность и поддержку версий. Разрабатывайте ваши интерфейсы экспорта DLL для передачи информации в виде значения или для работы в памяти, которая передается вызывающим объектом, а не в локально выделенной памяти, которая возвращается вызывающей стороне. Используйте методы маршалинга для копирования структурированных данных между исполняемыми образами. Инкапсулируйте ресурсы локально и допускайте действия только через дескрипторы или функции, которые вы предоставляете клиентам.

Кроме того, вы можете избежать некоторых из этих проблем, если для всех образов в процессе будет использоваться одна и та же версия динамически загружаемой библиотеки CRT. Чтобы использовать для всех компонентов одну и ту же версию DLL библиотеки CRT, создайте их с помощью параметра **/MD** и примените одни и те же настройки параметров и набор инструментов компилятора.

Необходимо соблюдать осторожность, если ваша программа передает некоторые объекты CRT (например, дескрипторы файлов, языковые стандарты и переменные среды) через границы библиотеки DLL даже при использовании одной и той же версии CRT. Дополнительные сведения о связанных проблемах и способах их устранения см. в разделе [Потенциальные ошибки при передаче объектов CRT через границы DLL](../c-runtime-library/potential-errors-passing-crt-objects-across-dll-boundaries.md).


## <a name="see-also"></a>См. также

- [Справочник по библиотеке времени выполнения C](../c-runtime-library/c-run-time-library-reference.md)
