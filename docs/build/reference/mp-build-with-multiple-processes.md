---
title: /MP (построить с несколькими процессами) | Документы Microsoft
ms.custom: ''
ms.date: 02/22/2018
ms.technology:
- cpp-tools
ms.topic: reference
f1_keywords:
- VC.Project.VCCLCompilerTool.MultiProcessorCompilation
dev_langs:
- C++
helpviewer_keywords:
- -MP compiler option (C++)
- /MP compiler option (C++)
- MP compiler option (C++)
- cl.exe compiler, multi-process build
author: corob-msft
ms.author: corob
ms.workload:
- cplusplus
ms.openlocfilehash: 29f7fd00a9d24b1941830690633befc75c39eb32
ms.sourcegitcommit: be2a7679c2bd80968204dee03d13ca961eaa31ff
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
---
# <a name="mp-build-with-multiple-processes"></a>/MP (Построить с несколькими процессами)

Параметр **/MP** позволяет сократить общее время на компиляцию исходных файлов в командной строке. **/MP** предписывает компилятору создавать одну или несколько собственных копий, каждую в отдельном процессе. Затем эти копии одновременно компилируют исходные файлы. Следовательно, общее время на создание исходных файлов значительно сокращается.

## <a name="syntax"></a>Синтаксис

> **/MP**[*processMax*]

## <a name="arguments"></a>Аргументы

*processMax*<br/>
Максимальное количество процессов, которые может создать компилятор (необязательно).

*ProcessMax* аргумента должно находиться в диапазоне от 1 до 65536. В противном случае компилятор выдает предупреждение **D9014**, игнорирует *processMax* аргумента и предполагается максимальное число процессов — 1.

Если не указан *processMax* аргумента, компилятор возвращает число [эффективных процессоров](#effective_processors) на компьютере с операционной системой и создает процесс для каждого процессора.

## <a name="remarks"></a>Примечания

Параметр компилятора **/MP** может значительно сократить время построения при компиляции большого числа файлов. Чтобы сократить время построения, компилятор создает до *processMax* свою копию, а затем использует эти копии для компиляции исходных файлов, в то же время. Параметр **/MP** применим к компиляциям, но не используется для связывания или создания кода во время компоновки. По умолчанию параметр **/MP** отключен.

Улучшение в построении зависит от числа процессоров на компьютере, количества компилируемых файлов и доступности системных ресурсов, таких как емкость ввода-вывода. Поэкспериментируйте с параметром **/MP** , чтобы определить оптимальные настройки для построения конкретного проекта. Советы в разделе [Рекомендации](#guidelines)помогут вам принять правильное решение.

## <a name="incompatible-options-and-language-features"></a>Несовместимые параметры и языковые компоненты

Параметр **/MP** не совместим с некоторыми параметрами компилятора и языковыми компонентами. При использовании параметра компилятора, несовместимые с **/MP** параметр, компилятор выдает предупреждение **D9030** и игнорирует **/MP** параметр. При использовании несовместимого языкового компонента, компилятор выдает ошибку [C2813](../../error-messages/compiler-errors-2/compiler-error-c2813.md) затем завершается или продолжается в зависимости от текущей предупреждение уровня параметр компилятора.

> [!NOTE]
> Большинство параметров являются несовместимыми, так как если бы они были разрешены, параллельно выполняющиеся компиляторы одновременно записывали бы свои выходные данные в консоль или в конкретный файл. В результате произошло бы смешивание и искажение выходных данных. В некоторых случаях сочетание параметров может снизить производительность.

В следующей таблице перечислены параметры компилятора и языковые компоненты, несовместимые с параметром **/MP** .

|Параметр или языковой компонент|Описание|
|--------------------------------|-----------------|
|Директива препроцессора[#import](../../preprocessor/hash-import-directive-cpp.md) |Преобразует типы библиотеки типов в классы C++, а затем записывает эти классы в файл заголовка.|
|[/E](../../build/reference/e-preprocess-to-stdout.md), [/EP](../../build/reference/ep-preprocess-to-stdout-without-hash-line-directives.md)|Копирует выходные данные препроцессора в стандартный поток вывода (**stdout**).|
|[/Gm](../../build/reference/gm-enable-minimal-rebuild.md)|Включает инкрементную перестройку.|
|[/showIncludes](../../build/reference/showincludes-list-include-files.md)|Записывает список включаемых файлов в стандартную ошибку (**stderr**).|
|[/Yc](../../build/reference/yc-create-precompiled-header-file.md)|Создает файл предкомпилированного заголовка.|

## <a name="diagnostic-messages"></a>Диагностические сообщения

При указании параметра или языкового компонента, несовместимого с параметром **/MP** , вы получите соответствующее диагностическое сообщение. В следующей таблице перечислены возможные сообщения и поведение компилятора:

|Диагностическое сообщение|Описание|Поведение компилятора|
|------------------------|-----------------|-----------------------|
|**C2813**|Директива **#import** не совместима с параметром **/MP** .|Компиляция заканчивается, если для параметра [Порог предупреждений компилятора](../../build/reference/compiler-option-warning-level.md) не указано иное.|
|**D9014**|Указано недопустимое значение для *processMax* аргумент.|Компилятор игнорирует недопустимое значение и принимает значение равным 1.|
|**D9030**|Указанный параметр не совместим с **/MP**.|Компилятор игнорирует параметр **/MP** .|

## <a name="guidelines"></a> Рекомендации

### <a name="measure-performance"></a>Измерение производительности

Для измерения производительности используется общее время построения. Его можно измерить с помощью обычных часов или программного обеспечения, которое вычисляет разницу между началом и завершением построения. Если компьютер оснащен несколькими процессорами, физические часы могут дать более точные результаты, чем измерение времени с помощью программного обеспечения.

### <a name="effective_processors"></a> Effective Processors

На компьютере можно установить один или несколько виртуальных процессоров, которые также называют *эффективных процессоров*, для каждого из его физических процессоров. Каждый физический процессор может состоять из одного или нескольких ядер, а при использовании технологии Hyper-Threading каждое ядро определяется операционной системой как два отдельных виртуальных процессора.

Например, компьютер имеет один эффективный процессор, если он оснащен одним физическим процессором с одним ядром и отключенной технологией Hyper-Threading. Другой вариант: компьютер имеет восемь эффективных процессоров, если он оснащен двумя физическими процессорами, каждый из которых имеет два ядра, и для всех ядер включена технология Hyper-Threading. То есть (8 эффективных процессоров) = (2 физических процессоров) x (2 ядра на процессор) x (2 эффективных процессора на ядро, из-за Hyper-Threading).

Если не указан *processMax* аргумент в **/MP** параметр, компилятор получает число эффективных процессоров от операционной системы и создает по одному процессу на каждый эффективный процессор. Тем не менее, компилятор не может гарантировать, что отдельно взятый процесс будет выполняться на конкретном процессоре; это решение принимает операционная система.

### <a name="number-of-processes"></a>Число процессов

Компилятор вычисляет число процессов, которые будут использоваться для компиляции исходных файлов. При этом выбирается меньшее значение из количества исходных файлов, указанных в командной строке, и числа процессов, явно или неявно указанных в параметре **/MP** . Можно явно задать максимальное число процессов, при указании *processMax* аргумент **/MP** параметр. Или можно использовать значение по умолчанию равно числу эффективных процессоров в компьютере, если не указан *processMax* аргумент.

Например, можно ввести следующее в командной строке:

`cl /MP7 a.cpp b.cpp c.cpp d.cpp e.cpp`

В этом случае компилятор использует пять процессов, поскольку это меньшее значение из числа исходных файлов (пять) и максимального количества процессов (семь). Теперь предположим, что компьютер имеет два эффективных процессора и вы ввели следующую команду в командной строке:

`cl /MP a.cpp b.cpp c.cpp`

В этом случае операционная система сообщает о двух процессорах, поэтому компилятор использует два процесса в своих вычислениях. В результате компилятор произведет построение с использованием двух процессов, поскольку это меньшее число из двух процессов и трех исходных файлов.

### <a name="source-files-and-build-order"></a>Исходные файлы и порядок построения

Исходные файлы могут компилироваться не в том порядке, в котором они появляются в командной строке. Хотя компилятор создает набор процессов, содержащий копии компилятора, операционная система все равно планирует время выполнения каждого процесса. Следовательно, вы не можете гарантировать, что исходные файлы будут компилироваться в определенном порядке.

Исходный файл компилируется, когда доступен процесс для его компиляции. Если число файлов превышает число процессов, первый набор файлов компилируется свободными процессами. Оставшиеся файлы обрабатываются тогда, когда процесс завершает обработку предыдущих файлов и доступен для работы на одном из остальных файлов.

Не указывайте один и тот же исходный файл в командной строке несколько раз. Это может произойти, например, если инструмент автоматически создает файл [makefile](../../build/contents-of-a-makefile.md) , основанный на данных о зависимостях в проекте. Если параметр **/MP** не указан, компилятор последовательно обрабатывает список файлов и повторно компилирует каждое вхождение файла. Тем не менее, если указать параметр **/MP** , разные компиляторы могут одновременно скомпилировать один и тот же файл. Таким образом, разные компиляторы попытаются одновременно выполнить запись в один и тот же выходной файл. Один из компиляторов получит монопольный доступ на запись в выходной файл и успешно выполнит ее, а работа остальных компиляторов завершится из-за ошибки доступа к файлу.

### <a name="using-type-libraries-import"></a>Использование библиотек типов (#import)

Компилятор не поддерживает использование директивы [#import](../../preprocessor/hash-import-directive-cpp.md) с параметром **/MP** . Если возможно, выполните следующие действия, чтобы устранить проблему.

- Переместите все директивы `#import` из различных исходных файлов в один или несколько файлов, затем скомпилируйте эти файлы без параметра **/MP** . Результатом является набор файлов заголовка.

- В оставшихся исходных файлах вставьте директивы [#include](../../preprocessor/hash-include-directive-c-cpp.md) , определяющие созданные заголовки, и скомпилируйте эти исходные файлы с помощью параметра **/MP** .

### <a name="visual-studio-project-settings"></a>Параметры проекта Visual Studio

#### <a name="the-msbuildexe-tool"></a>Инструмент MSBUILD.exe

[!INCLUDE[vsprvs](../../assembler/masm/includes/vsprvs_md.md)] использует инструмент [MSBuild.exe](/visualstudio/msbuild/msbuild-reference) для создания решений и проектов. **/Maxcpucount:**_номер_ (или **/m:**_номер_) параметр командной строки программы MSBuild.exe можно создать несколько проектов в то же время. С помощью параметра компилятора **/MP** можно одновременно построить несколько блоков компиляции. Если это требуется для вашего приложения, сократите время построения решения с помощью одного или обоих параметров **/MP** и **/maxcpucount**.

Время построения решения отчасти зависит от числа процессов, выполняющих построение. *Номер* аргумент [/maxcpucount](/visualstudio/msbuild/msbuild-command-line-reference) MSBuild определяет максимальное число проектов для сборки одновременно. Аналогичным образом *processMax* аргумент **/MP** параметр компилятора указывает максимальное количество единиц компиляции для построения, в то же время. Если **/maxcpucount** указывает параметр *P* проекты и **/MP** указывает параметр *C* обрабатывает более *P*  x *C* выполнение процессов одновременно.

 Рекомендации для принятия решения об использовании MSBuild или **/MP** технология — следующим образом:

- Если существует много проектов, в каждом проекте для нескольких файлов, используйте средство MSBuild.

- При наличии нескольких проектов, каждый из которых содержит большое количество файлов, используйте параметр **/MP** .

- Если число проектов и файлов в каждом проекте сбалансирована, используйте MSBuild и **/MP**. Изначально параметр **/maxcpucount** задается равным числу проектов для построения, а параметр **/MP** — числу процессоров на компьютере. Измерьте производительность и произведите настройку, чтобы добиться наилучших результатов. Повторите цикл, пока не будет достигнуто оптимальное общее время построения.

#### <a name="the-gm-compiler-option"></a>Параметр компилятора /Gm

По умолчанию построение проекта включает параметр компилятора **/Gm** (инкрементное построение) для отладочных построений и отключает его для построения выпуска. Таким образом, параметр компилятора **/MP** автоматически отключается в отладочных построениях, так как он конфликтует со значением по умолчанию параметра компилятора **/Gm** .

## <a name="see-also"></a>См. также

[директива #import](../../preprocessor/hash-import-directive-cpp.md)<br/>
[Справочник по командной строке](/visualstudio/msbuild/msbuild-command-line-reference)<br/>
[/Zf (ускоренное создание PDB-файла)](zf.md)<br/>
