---
title: 'Обмен данными с полями записей: Принцип работы RFX'
ms.date: 11/04/2016
helpviewer_keywords:
- record editing [C++], using RFX
- RFX (ODBC) [C++], updating data in recordsets
- scrolling [C++]
- ODBC [C++], RFX
- data binding [C++], DFX
- scrolling [C++], RFX
- RFX (ODBC) [C++], binding fields and parameters
ms.assetid: e647cacd-62b0-4b80-9e20-b392deca5a88
ms.openlocfilehash: 9e717d0f0ce3b8841feee2beb457fee7221fcf69
ms.sourcegitcommit: 6b3d793f0ef3bbb7eefaf9f372ba570fdfe61199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2020
ms.locfileid: "86403794"
---
# <a name="record-field-exchange-how-rfx-works"></a>Обмен данными с полями записей: Принцип работы RFX

В этом разделе объясняется процесс RFX. Это дополнительная тема, охватывающая следующие темы:

- [RFX и набор записей](#_core_rfx_and_the_recordset)

- [Процесс RFX](#_core_the_record_field_exchange_process)

> [!NOTE]
> Этот раздел относится к классам, производным от `CRecordset`, в которых пакетное получение строк не реализовано. Если вы используете пакетное получение строк, реализуется пакетный обмен полями записей (Bulk RFX). Bulk RFX аналогичен RFX. Сведения о различиях см. в разделе [набор записей: незначительная выборка записей (ODBC)](../../data/odbc/recordset-fetching-records-in-bulk-odbc.md).

## <a name="rfx-and-the-recordset"></a><a name="_core_rfx_and_the_recordset"></a>RFX и набор записей

Элементы данных поля объекта набора записей, взятые вместе, составляют буфер правки, в котором содержатся выбранные столбцы одной записи. Когда набор записей впервые открыт и собирается считать первую запись, RFX привязывает (связывает) Каждый выделенный столбец к адресу соответствующего элемента данных поля. Когда набор записей обновляет запись, функция RFX вызывает функции API ODBC для отправки инструкции SQL **Update** или **INSERT** в драйвер. RFX использует свои знания элементов данных поля, чтобы указать столбцы для записи.

Платформа создает резервную копию буфера редактирования на определенных этапах, чтобы при необходимости можно было восстановить его содержимое. RFX создает резервную копию буфера редактирования перед добавлением новой записи и перед редактированием существующей записи. Он восстанавливает буфер редактирования в некоторых случаях, например после `Update` вызова следующего `AddNew` . Буфер редактирования не восстанавливается, если вы отменяете вновь измененный буфер редактирования, например, перемещаясь на другую запись перед вызовом `Update` .

Помимо обмена данными между источником данных и элементами данных поля набора записей, RFX управляет параметрами привязки. При открытии набора записей все элементы данных параметров привязываются в порядке заполнители "?" в инструкции SQL, которая `CRecordset::Open` конструируется. Дополнительные сведения см. [в разделе набор записей: Параметризация набора записей (ODBC)](../../data/odbc/recordset-parameterizing-a-recordset-odbc.md).

Переопределение класса набора записей `DoFieldExchange` выполняет всю работу, перемещая данные в обоих направлениях. Как и при обмене данными в диалоговых окнах (DDX), RFX нуждается в сведениях о членах данных класса. Мастер предоставляет необходимые сведения, записывая зависящую от набора записей реализацию на `DoFieldExchange` основе имен элементов данных полей и типов данных, указанных в мастере.

## <a name="record-field-exchange-process"></a><a name="_core_the_record_field_exchange_process"></a>Процесс обмена полями записи

В этом разделе описывается последовательность событий RFX при открытии объекта набора записей, а также по мере добавления, обновления и удаления записей. Последовательность таблиц [операций RFX во время открытия набора записей](#_core_sequence_of_rfx_operations_during_recordset_open) и табличная [последовательность операций RFX во время прокрутки](#_core_sequence_of_rfx_operations_during_scrolling) этого раздела показывает процесс, `Move` выполняемый в RFX, обрабатывает команду в наборе записей, а также как RFX управляет обновлением. Во время этих процессов для выполнения множества различных операций вызывается метод [DoFieldExchange](../../mfc/reference/crecordset-class.md#dofieldexchange) . `m_nOperation`Запрошенная операция определяется элементом данных объекта [кфиелдексчанже](../../mfc/reference/cfieldexchange-class.md) . Может оказаться полезным прочитать [набор записей: как набор записей выбирает записи (ODBC)](../../data/odbc/recordset-how-recordsets-select-records-odbc.md) и [набор записей. как набор записей ОБНОВЛЯЕТ записи (ODBC)](../../data/odbc/recordset-how-recordsets-update-records-odbc.md) перед чтением этого материала.

### <a name="rfx-initial-binding-of-columns-and-parameters"></a><a name="_mfc_rfx.3a_.initial_binding_of_columns_and_parameters"></a>RFX: Начальная привязка столбцов и параметров

При вызове функции [открытого](../../mfc/reference/crecordset-class.md#open) члена объекта Recordset в указанном порядке выполняются следующие действия RFX:

- Если набор записей содержит элементы данных параметров, платформа вызывает метод `DoFieldExchange` для привязки параметров к заполнителям параметров в строке инструкции SQL набора записей. Для каждого заполнителя, найденного в инструкции **SELECT** , используется зависимое от типа данных представление значения параметра. Это происходит после подготовки инструкции SQL, но до ее выполнения. Дополнительные сведения о подготовке инструкции см. в описании `::SQLPrepare` функции в *справочнике программиста*по ODBC.

- Платформа вызывает `DoFieldExchange` второй раз, чтобы привязать значения выбранных столбцов к соответствующим элементам данных поля в наборе записей. При этом объект набора записей устанавливается в виде буфера редактирования, содержащего столбцы первой записи.

- Набор записей выполняет инструкцию SQL, и источник данных выбирает первую запись. Столбцы записи загружаются в элементы данных полей набора записей.

В следующей таблице показана последовательность операций RFX при открытии набора записей.

### <a name="sequence-of-rfx-operations-during-recordset-open"></a><a name="_core_sequence_of_rfx_operations_during_recordset_open"></a>Последовательность операций RFX при открытии набора записей

|Операция|Операция DoFieldExchange|Операция базы данных или SQL|
|--------------------|-------------------------------|-----------------------------|
|1. Откройте набор записей.|||
||2. Создайте инструкцию SQL.||
|||3. Отправьте SQL.|
||4. Связывание членов данных параметров.||
||5. Привязка элементов данных поля к столбцам.||
|||6. ODBC выполняет перемещение и заполняет данные.|
||7. Исправьте данные для C++.||

Наборы записей используют подготовленное выполнение ODBC, чтобы обеспечить быстрое перевыполнение запросов с помощью одной и той же инструкции SQL. Дополнительные сведения о подготовленном выполнении см. в [справочнике программиста по ODBC](/sql/odbc/reference/odbc-programmer-s-reference).

### <a name="rfx-scrolling"></a><a name="_mfc_rfx.3a_.scrolling"></a>RFX: прокрутка

При прокрутке от одной записи к другой платформа вызывает метод `DoFieldExchange` , чтобы заменить значения, ранее сохраненные в элементах данных поля, значениями для новой записи.

В следующей таблице показана последовательность операций RFX при переходе пользователя из записи в запись.

### <a name="sequence-of-rfx-operations-during-scrolling"></a><a name="_core_sequence_of_rfx_operations_during_scrolling"></a>Последовательность операций RFX во время прокрутки

|Операция|Операция DoFieldExchange|Операция базы данных или SQL|
|--------------------|-------------------------------|-----------------------------|
|1. вызов `MoveNext` или одна из других функций Move.|||
|||2. ODBC выполняет перемещение и заполняет данные.|
||3. Исправьте данные для C++.||

### <a name="rfx-adding-new-records-and-editing-existing-records"></a><a name="_mfc_rfx.3a_.adding_new_records_and_editing_existing_records"></a>RFX: Добавление новых записей и изменение существующих записей

При добавлении новой записи набор записей действует как буфер редактирования для создания содержимого новой записи. Как и при добавлении записей, изменение записей предполагает изменение значений элементов данных полей набора записей. С точки зрения RFX последовательность выглядит следующим образом:

1. Вызов функции [AddNew](../../mfc/reference/crecordset-class.md#addnew) или [Edit](../../mfc/reference/crecordset-class.md#edit) члена набора записей приводит к тому, что RFX сохраняет текущий буфер редактирования, чтобы его можно было восстановить позже.

1. `AddNew`или `Edit` подготавливает поля в буфере редактирования, чтобы RFX мог обнаруживать измененные элементы данных поля.

   Так как новая запись не имеет предыдущих значений для сравнения новых с, `AddNew` присваивает каждому элементу данных поля значение PSEUDO_NULL. Позднее при вызове функция `Update` RFX сравнивает значение каждого элемента данных со значением PSEUDO_NULL. При наличии различий был задан элемент данных. (PSEUDO_NULL не совпадает со столбцом записи со значением true NULL и не является ни одним из таких же, что и C++ NULL.)

   В отличие от `Update` вызова функции `AddNew` , `Update` вызов для `Edit` сравнения обновленных значений с ранее сохраненными значениями вместо использования PSEUDO_NULL. Разница заключается в том, что не `AddNew` имеет ранее сохраненных значений для сравнения.

1. Вы напрямую задаете значения элементов данных поля, значения которых необходимо изменить или которые нужно заполнить для новой записи. Это может быть вызов `SetFieldNull` .

1. Вызов метода [Update](../../mfc/reference/crecordset-class.md#update) проверяет элементы данных измененных полей, как описано в шаге 2 (см. таблицу [операций RFX во время прокрутки](#_core_sequence_of_rfx_operations_during_scrolling)). Если ничего не изменилось, `Update` возвращает 0. Если некоторые элементы данных полей изменились, `Update` подготавливает и выполняет инструкцию SQL **INSERT** , содержащую значения для всех обновленных полей в записи.

1. Для `AddNew` , `Update` завершается восстановлением ранее сохраненных значений записи, которая была текущей до `AddNew` вызова. Для `Edit` новые, измененные значения остаются на месте.

В следующей таблице показана последовательность операций RFX при добавлении новой записи или редактировании существующей записи.

### <a name="sequence-of-rfx-operations-during-addnew-and-edit"></a>Последовательность операций RFX во время выполнения AddNew и Edit

|Операция|Операция DoFieldExchange|Операция базы данных или SQL|
|--------------------|-------------------------------|-----------------------------|
|1. вызовите `AddNew` или `Edit` .|||
||2. Создайте резервную копию буфера редактирования.||
||3. для `AddNew` , пометьте элементы данных поля как "Clean" и NULL.||
|4. присвойте значения элементам данных полей набора записей.|||
|5. вызовите метод `Update` .|||
||6. Проверьте наличие измененных полей.||
||7. Построение инструкции SQL **INSERT** для `AddNew` или инструкции **Update** для `Edit` .||
|||8. Отправка SQL.|
||9. для `AddNew` , восстановите буфер редактирования до резервной копии содержимого. Для `Edit` удалите резервную копию.||

### <a name="rfx-deleting-existing-records"></a>RFX: удаление существующих записей

При удалении записи RFX устанавливает для всех полей значение NULL в качестве напоминания о том, что запись удалена, и ее необходимо переместить. Никаких других сведений о последовательности RFX не требуется.

## <a name="see-also"></a>См. также раздел

[Обмен полями записей (RFX)](../../data/odbc/record-field-exchange-rfx.md)<br/>
[Потребление MFC ODBC](../../mfc/reference/adding-an-mfc-odbc-consumer.md)<br/>
[Макросы, глобальные функции и глобальные переменные](../../mfc/reference/mfc-macros-and-globals.md)<br/>
[Класс Кфиелдексчанже](../../mfc/reference/cfieldexchange-class.md)<br/>
[CRecordset::D Офиелдексчанже](../../mfc/reference/crecordset-class.md#dofieldexchange)
