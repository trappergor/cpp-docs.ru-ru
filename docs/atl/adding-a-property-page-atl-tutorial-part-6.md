---
title: Добавление страницы свойств (учебник ATL, часть 6)
ms.custom: get-started-article
ms.date: 09/27/2018
ms.assetid: df80d255-e7ea-49d9-b940-3f012e90cf9b
ms.openlocfilehash: 2c487d1446f5d1050868f2066359e9639f474ba3
ms.sourcegitcommit: 00e26915924869cd7eb3c971a7d0604388abd316
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2019
ms.locfileid: "65524688"
---
# <a name="adding-a-property-page-atl-tutorial-part-6"></a>Добавление страницы свойств (учебник ATL, часть 6)

> [!NOTE] 
> Мастер поставщика OLE DB в ATL недоступен в Visual Studio 2019 и более поздних версиях.

Страницы свойств реализуются в качестве отдельных COM-объектов, которые при необходимости позволяют предоставлять к ним общий доступ. В рамках этой части вы добавите страницу свойств в элемент управления, выполнив следующие задачи:

- Создание ресурса страницы свойств.

- Добавление кода для создания страницы свойств и управления ею.

- Добавление страницы свойств в элемент управления.

## <a name="creating-the-property-page-resource"></a>Создание ресурса страницы свойств

Чтобы добавить страницу свойств в свой элемент управления, используйте шаблон страницы свойств ATL.

### <a name="to-add-a-property-page"></a>Добавление страницы свойств

1. В **обозревателе решений** щелкните `Polygon` правой кнопкой мыши.

1. В контекстном меню выберите **Добавить** > **Новый элемент**.

1. В списке шаблонов выберите**Библиотека ATL** > **Страница свойств ATL** и щелкните **Добавить**.

1. После открытия **мастера страницы свойств ATL** введите *PolyProp* в поле **Краткое имя**.

1. Щелкните **Строки**, чтобы открыть страницу **Строки** и введите **&Polygon** в поле **Заголовок**.

   **Заголовок** страницы свойств представляет собой строку, расположенную на вкладке страницы. **Строка документации** — это описание, которое фрейм свойства помещает в строку состояния или подсказку. Обратите внимание, что стандартный фрейм свойств в настоящее время не использует эту строку, поэтому вы можете оставить в ней содержимое по умолчанию. На данном этапе вы не будете создавать **файл справки**, поэтому удалите запись, указанную в этом текстовом поле.

1. Щелкните **Готово** и объект страницы свойств будет создан.

Будут созданы следующие три файла:

|Файл|Описание|
|----------|-----------------|
|PolyProp.h|Содержит класс C++ `CPolyProp`, который реализует страницу свойств.|
|PolyProp.cpp|Включает файл PolyProp.h.|
|PolyProp.rgs|Сценарий для реестра, который регистрирует объект страницы свойств.|

Кроме того, в код будут внесены следующие изменения:

- В файле Polygon.cpp в карту записи объекта добавляется новая страница свойств.

- В файл Polygon.idl добавляется класс `PolyProp`.

- В ресурс проекта добавляется новый файл сценария для реестра PolyProp.rgs.

- В ресурс проекта для страницы свойств добавляется шаблон диалогового окна.

- В таблицу строк ресурсов добавляются указанные вами строки свойств.

Теперь добавьте поля, которые должны отображаться на странице свойств.

### <a name="to-add-fields-to-the-property-page"></a>Добавление полей на страницу свойств

1. В **обозревателе решений** дважды щелкните файл ресурсов Polygon.rc. Откроется **представление ресурсов**.

1. В **представлении ресурсов** разверните узел `Dialog` и дважды щелкните `IDD_POLYPROP`. Обратите внимание, что открывшееся диалоговое окно пустое. В нем находится лишь метка, указывающая, что сюда необходимо вставить элементы управления.

1. Щелкните эту метку и измените ее на значение `Sides:`, изменив текст **заголовка** в окне **свойств**.

1. Измените размер поля метки, чтобы оно соответствовало размеру текста.

1. Перетащите **элемент управления "Поле ввода"** с **панели инструментов**, расположенной справа от метки.

1. Наконец, в окне **Свойства** измените **идентификатор** элемента управления "Поле ввода" на `IDC_SIDES`.

На этом процесс создания ресурса страницы свойств завершается.

## <a name="adding-code-to-create-and-manage-the-property-page"></a>Добавление кода для создания страницы свойств и управления ею

Теперь, после создания ресурса страницы свойств, вам нужно написать код реализации.

Сначала включите класс `CPolyProp`, чтобы задать количество сторон в вашем объекте при нажатии кнопки **Применить**.

### <a name="to-modify-the-apply-function-to-set-the-number-of-sides"></a>Изменение функции Apply для установки количества сторон

1. Замените функцию `Apply` в файле PolyProp.h следующим кодом:

    [!code-cpp[NVC_ATL_Windowing#58](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_1.h)]

К странице свойств можно подключить несколько клиентов одновременно, поэтому функция `Apply` выполняет циклические запросы `put_Sides` для каждого клиента со значением, извлеченным из поля редактирования. Вы используете класс [CComQIPtr](../atl/reference/ccomqiptr-class.md), который выполняет запрос `QueryInterface` для каждого объекта, чтобы получить интерфейс `IPolyCtl` из интерфейса `IUnknown`, который хранится в массиве `m_ppUnk`.

Теперь код проверяет, действительно ли выполняется настройка свойства `Sides`. Если происходит сбой, код отображает окно сообщения с подробными сведениями об ошибке из интерфейса `IErrorInfo`. Как правило, контейнер запрашивает у объекта интерфейс `ISupportErrorInfo` и для начала вызывает `InterfaceSupportsErrorInfo`, чтобы определить, поддерживает ли объект сведения об ошибках настройки. Этот этап можно пропустить.

[CComPtr](../atl/reference/ccomptr-class.md) помогает автоматически обрабатывать подсчет ссылок, поэтому нет необходимости вызывать `Release` в интерфейсе. `CComBSTR` помогает в обработке BSTR, поэтому вам не нужно выполнять последний вызов `SysFreeString`. Кроме того, вы используете один из множества классов преобразования строк, поэтому при необходимости можете преобразовать BSTR (именно поэтому в начале функции находится макрос USES_CONVERSION).

Вам также нужно установить флаг наличия несохраненных изменений на странице свойств, чтобы указать необходимость включения кнопки **Применить**. Это происходит, когда пользователь изменяет значение в поле редактирования **Sides** (Стороны).

### <a name="to-handle-the-apply-button"></a>Обработка кнопки "Применить"

1. В **представлении классов** щелкните правой кнопкой мыши `CPolyProp` и выберите **Свойства** в контекстном меню.

1. В окне **Свойства** щелкните значок **События**.

1. Разверните узел `IDC_SIDES` в списке событий.

1. Выберите `EN_CHANGE` и в раскрывающемся меню справа щелкните **\<Добавить> OnEnChangeSides** . Объявление обработчика `OnEnChangeSides` будет добавлено в файл Polyprop.h, а реализация обработчика — в файл Polyprop.cpp.

После этого вам необходимо изменить обработчик.

### <a name="to-modify-the-onenchangesides-method"></a>Изменение метода OnEnChangeSides

1. В файле Polyprop.cpp добавьте следующий код в метод `OnEnChangeSides` (удалив код, который там поместил мастер):

    [!code-cpp[NVC_ATL_Windowing#59](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_2.cpp)]

`OnEnChangeSides` вызывается при отправке сообщения `WM_COMMAND` с уведомлением `EN_CHANGE` для элемента управления `IDC_SIDES`. Затем `OnEnChangeSides` вызывает `SetDirty` и передает значение TRUE, чтобы указать, что страница свойств теперь является черновиком, а кнопка **Применить**  должна быть включена.

## <a name="adding-the-property-page-to-the-control"></a>Добавление страницы свойств в элемент управления

Шаблон и мастер страницы свойств ATL не добавляют страницу свойств в элемент управления автоматически, так как в проекте может содержаться несколько элементов управления. Вам нужно будет добавить запись в карту свойств элемента управления.

### <a name="to-add-the-property-page"></a>Добавление страницы свойств

1. Откройте файл PolyCtl.h и добавьте приведенные ниже строки в карту свойств:

    [!code-cpp[NVC_ATL_Windowing#60](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_3.h)]

Карта свойств элемента управления должна выглядеть следующим образом:

[!code-cpp[NVC_ATL_Windowing#61](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_4.h)]

Вы могли бы добавить макрос `PROP_PAGE` с CLSID вашей страницы свойств, но при использовании макроса `PROP_ENTRY`, как показано выше, значение свойства `Sides` также сохраняется при сохранении элемента управления.

К трем параметрам макроса относится описание свойства, DISPID свойства и CLSID страницы свойств, которая содержит свойство. Это удобно если, к примеру, вы загружаете элемент управления в Visual Basic и задаете количество сторон во время разработки. Так как количество сторон сохранено, при перезагрузке проекта Visual Basic оно будет восстановлено.

## <a name="building-and-testing-the-control"></a>Сборка и тестирование элемента управления

Теперь выполните сборку этого элемента управления и вставьте его в контейнер для проверки элементов ActiveX. В **контейнере для проверки** в меню **Правка** щелкните **PolyCtl Class Object** (Объект класса PolyCtl). Откроется страница свойств с добавленными сведениями.

Кнопка **Применить** изначально отключена. Начните вводить значение в поле **Sides** (Стороны) и кнопка **Применить** станет активной. После ввода значения нажмите кнопку **Применить**. Отображение элемента управления изменится и кнопка **Применить** снова отключится. Попробуйте ввести недопустимое значение. Отобразится окно сообщения с описанием ошибки, которое вы настроили с помощью функции `put_Sides`.

После этого необходимо разместить элемент управления на странице.

[Возвратиться к пятой части](../atl/adding-an-event-atl-tutorial-part-5.md) | [Перейти к седьмой части](../atl/putting-the-control-on-a-web-page-atl-tutorial-part-7.md).

## <a name="see-also"></a>См. также

[Руководство](../atl/active-template-library-atl-tutorial.md)
