---
title: Класс Ксреадпул
ms.date: 11/04/2016
f1_keywords:
- CThreadPool
- ATLUTIL/ATL::CThreadPool
- ATLUTIL/ATL::CThreadPool::CThreadPool
- ATLUTIL/ATL::CThreadPool::AddRef
- ATLUTIL/ATL::CThreadPool::GetNumThreads
- ATLUTIL/ATL::CThreadPool::GetQueueHandle
- ATLUTIL/ATL::CThreadPool::GetSize
- ATLUTIL/ATL::CThreadPool::GetTimeout
- ATLUTIL/ATL::CThreadPool::Initialize
- ATLUTIL/ATL::CThreadPool::QueryInterface
- ATLUTIL/ATL::CThreadPool::QueueRequest
- ATLUTIL/ATL::CThreadPool::Release
- ATLUTIL/ATL::CThreadPool::SetSize
- ATLUTIL/ATL::CThreadPool::SetTimeout
- ATLUTIL/ATL::CThreadPool::Shutdown
helpviewer_keywords:
- CThreadPool class
ms.assetid: 06683718-01b9-413c-9481-2dc1734ec70f
ms.openlocfilehash: 12b28cd4f54fa426bb6ad2b2710d62b426ada2b6
ms.sourcegitcommit: 1f009ab0f2cc4a177f2d1353d5a38f164612bdb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/27/2020
ms.locfileid: "87226546"
---
# <a name="cthreadpool-class"></a>Класс Ксреадпул

Этот класс предоставляет пул рабочих потоков, которые обрабатывают очередь рабочих элементов.

## <a name="syntax"></a>Синтаксис

```
template <class Worker, class ThreadTraits = DefaultThreadTraits>
class CThreadPool : public IThreadPoolConfig
```

#### <a name="parameters"></a>Параметры

*Работников*<br/>
Класс, которому соответствует [Рабочая роль, архетипа](../../atl/reference/worker-archetype.md) предоставление кода, используемого для обработки рабочих элементов, поставленных в очередь пула потоков.

*среадтраитс*<br/>
Класс, предоставляющий функцию, используемую для создания потоков в пуле.

## <a name="members"></a>Элементы

### <a name="public-constructors"></a>Открытые конструкторы

|Имя|Описание:|
|----------|-----------------|
|[Ксреадпул:: Ксреадпул](#cthreadpool)|Конструктор для пула потоков.|
|[Ксреадпул:: ~ Ксреадпул](#dtor)|Деструктор для пула потоков.|

### <a name="public-methods"></a>Открытые методы

|name|Описание:|
|----------|-----------------|
|[Ксреадпул:: AddRef](#addref)|Реализация метода `IUnknown::AddRef`.|
|[Ксреадпул:: Жетнумсреадс](#getnumthreads)|Вызовите этот метод, чтобы получить количество потоков в пуле.|
|[Ксреадпул:: Жеткуеуехандле](#getqueuehandle)|Вызовите этот метод, чтобы получить маркер порта завершения ввода-вывода, используемого для очереди рабочих элементов.|
|[Ксреадпул:: DataSize](#getsize)|Вызовите этот метод, чтобы получить количество потоков в пуле.|
|[Ксреадпул:: не истечение времени](#gettimeout)|Вызовите этот метод, чтобы получить максимальное время в миллисекундах, в течение которого пул потоков будет ожидать завершения работы потока.|
|[Ксреадпул:: Initialize](#initialize)|Вызовите этот метод, чтобы инициализировать пул потоков.|
|[Ксреадпул:: QueryInterface](#queryinterface)|Реализация метода `IUnknown::QueryInterface`.|
|[Ксреадпул:: Куеуерекуест](#queuerequest)|Вызовите этот метод, чтобы поставить в очередь рабочий элемент, который будет обрабатываться потоком в пуле.|
|[Ксреадпул:: Release](#release)|Реализация метода `IUnknown::Release`.|
|[Ксреадпул:: SetSize](#setsize)|Вызовите этот метод, чтобы задать количество потоков в пуле.|
|[Ксреадпул:: SetTimeout](#settimeout)|Вызовите этот метод, чтобы задать максимальное время в миллисекундах, в течение которого пул потоков будет ожидать завершения работы потока.|
|[Ксреадпул:: Shutdown](#shutdown)|Вызовите этот метод, чтобы завершить работу пула потоков.|

## <a name="remarks"></a>Remarks

Потоки в пуле создаются и уничтожаются при инициализации пула, изменении их размера или завершении работы. Экземпляр класса *Worker* будет создан в стеке каждого рабочего потока в пуле. Каждый экземпляр будет находиться в течение времени существования потока.

Сразу после создания потока, *Worker*:: `Initialize` будет вызываться для объекта, связанного с этим потоком. Непосредственно перед уничтожением потока будет вызван *Рабочий процесс*:: `Terminate` . Оба метода должны принимать **`void`** <strong>\*</strong> аргумент. Значение этого аргумента передается в пул потоков с помощью параметра *Пвворкерпарам* [Ксреадпул:: Initialize](#initialize).

При наличии рабочих элементов в очереди и рабочих потоков, доступных для работы, Рабочий поток выберет элемент из очереди и вызовет `Execute` метод *рабочего* объекта для этого потока. Затем в метод передаются три элемента: элемент из очереди, который `pvWorkerParam` передается в *Worker*:: `Initialize` и *Worker*:: `Terminate` , и указатель на структуру [OVERLAPPED](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) , используемую для очереди порта завершения ввода-вывода.

*Рабочий* класс объявляет тип элементов, которые будут поставлены в очередь в пуле потоков, предоставляя typedef, *Worker*:: `RequestType` . Этот тип должен поддерживать приведение к ULONG_PTR и из него.

Примером *рабочего* класса является [класс кнонстателессворкер](../../atl/reference/cnonstatelessworker-class.md).

## <a name="inheritance-hierarchy"></a>Иерархия наследования

`IUnknown`

[исреадпулконфиг](../../atl/reference/ithreadpoolconfig-interface.md)

`CThreadPool`

## <a name="requirements"></a>Требования

**Заголовок:** файлов atlutil. h

## <a name="cthreadpooladdref"></a><a name="addref"></a>Ксреадпул:: AddRef

Реализация метода `IUnknown::AddRef`.

```
ULONG STDMETHODCALLTYPE AddRef() throw();
```

### <a name="return-value"></a>Возвращаемое значение

Всегда возвращает 1.

### <a name="remarks"></a>Remarks

Этот класс не реализует контроль времени существования с помощью подсчета ссылок.

## <a name="cthreadpoolcthreadpool"></a><a name="cthreadpool"></a>Ксреадпул:: Ксреадпул

Конструктор для пула потоков.

```
CThreadPool() throw();
```

### <a name="remarks"></a>Remarks

Инициализирует значение времени ожидания для ATLS_DEFAULT_THREADPOOLSHUTDOWNTIMEOUT. Время по умолчанию — 36 секунд. При необходимости можно определить собственное положительное целочисленное значение для этого символа, прежде чем включать файлов atlutil. h.

## <a name="cthreadpoolcthreadpool"></a><a name="dtor"></a>Ксреадпул:: ~ Ксреадпул

Деструктор для пула потоков.

```
~CThreadPool() throw();
```

### <a name="remarks"></a>Remarks

Вызывает [ксреадпул:: Shutdown](#shutdown).

## <a name="cthreadpoolgetnumthreads"></a><a name="getnumthreads"></a>Ксреадпул:: Жетнумсреадс

Вызовите этот метод, чтобы получить количество потоков в пуле.

```
int GetNumThreads() throw();
```

### <a name="return-value"></a>Возвращаемое значение

Возвращает число потоков в пуле.

## <a name="cthreadpoolgetqueuehandle"></a><a name="getqueuehandle"></a>Ксреадпул:: Жеткуеуехандле

Вызовите этот метод, чтобы получить маркер порта завершения ввода-вывода, используемого для очереди рабочих элементов.

```
HANDLE GetQueueHandle() throw();
```

### <a name="return-value"></a>Возвращаемое значение

Возвращает маркер очереди или значение NULL, если пул потоков не был инициализирован.

## <a name="cthreadpoolgetsize"></a><a name="getsize"></a>Ксреадпул:: DataSize

Вызовите этот метод, чтобы получить количество потоков в пуле.

```
HRESULT STDMETHODCALLTYPE GetSize(int* pnNumThreads) throw();
```

### <a name="parameters"></a>Параметры

*пннумсреадс*<br/>
заполняет Адрес переменной, которая в случае успешного выполнения получает количество потоков в пуле.

### <a name="return-value"></a>Возвращаемое значение

Возвращает S_OK при успешном выполнении или ошибку HRESULT при сбое.

## <a name="cthreadpoolgettimeout"></a><a name="gettimeout"></a>Ксреадпул:: не истечение времени

Вызовите этот метод, чтобы получить максимальное время в миллисекундах, в течение которого пул потоков будет ожидать завершения работы потока.

```
HRESULT STDMETHODCALLTYPE GetTimeout(DWORD* pdwMaxWait) throw();
```

### <a name="parameters"></a>Параметры

*пдвмаксваит*<br/>
заполняет Адрес переменной, которая в случае успешного выполнения получает максимальное время в миллисекундах, в течение которого пул потоков будет ожидать завершения работы потока.

### <a name="return-value"></a>Возвращаемое значение

Возвращает S_OK при успешном выполнении или ошибку HRESULT при сбое.

### <a name="remarks"></a>Remarks

Это значение времени ожидания используется [ксреадпул:: Shutdown](#shutdown) , если для этого метода не указано другое значение.

## <a name="cthreadpoolinitialize"></a><a name="initialize"></a>Ксреадпул:: Initialize

Вызовите этот метод, чтобы инициализировать пул потоков.

```
HRESULT Initialize(
    void* pvWorkerParam = NULL,
    int nNumThreads = 0,
    DWORD dwStackSize = 0,
    HANDLE hCompletion = INVALID_HANDLE_VALUE) throw();
```

### <a name="parameters"></a>Параметры

*пвворкерпарам*<br/>
Параметр рабочей роли, передаваемый `Initialize` методам, и в объекте рабочего потока `Execute` `Terminate` .

*ннумсреадс*<br/>
Запрошенное число потоков в пуле.

Если *ннумсреадс* является отрицательным, его абсолютное значение будет умножено на число процессоров на компьютере, чтобы получить общее число потоков.

Если *ннумсреадс* равен нулю, ATLS_DEFAULT_THREADSPERPROC будут умножены на количество процессоров на компьютере, чтобы получить общее число потоков.  Значение по умолчанию — 2 потока на процессор. При необходимости можно определить собственное положительное целочисленное значение для этого символа, прежде чем включать файлов atlutil. h.

*двстакксизе*<br/>
Размер стека для каждого потока в пуле.

*хкомплетион*<br/>
Маркер объекта, связываемый с портом завершения.

### <a name="return-value"></a>Возвращаемое значение

Возвращает S_OK при успешном выполнении или ошибку HRESULT при сбое.

## <a name="cthreadpoolqueryinterface"></a><a name="queryinterface"></a>Ксреадпул:: QueryInterface

Реализация метода `IUnknown::QueryInterface`.

```
HRESULT STDMETHODCALLTYPE QueryInterface(REFIID riid, void** ppv) throw();
```

### <a name="remarks"></a>Remarks

Объекты этого класса могут быть успешно запрошены для `IUnknown` интерфейсов и [исреадпулконфиг](../../atl/reference/ithreadpoolconfig-interface.md) .

## <a name="cthreadpoolqueuerequest"></a><a name="queuerequest"></a>Ксреадпул:: Куеуерекуест

Вызовите этот метод, чтобы поставить в очередь рабочий элемент, который будет обрабатываться потоком в пуле.

```
BOOL QueueRequest(Worker::RequestType request) throw();
```

### <a name="parameters"></a>Параметры

*request*<br/>
Запрос для постановки в очередь.

### <a name="return-value"></a>Возвращаемое значение

Возвращает TRUE при успешном выполнении, FALSE в случае сбоя.

### <a name="remarks"></a>Remarks

Этот метод добавляет рабочий элемент в очередь. Потоки в пуле выбирают элементы за пределами очереди в порядке их получения.

## <a name="cthreadpoolrelease"></a><a name="release"></a>Ксреадпул:: Release

Реализация метода `IUnknown::Release`.

```
ULONG STDMETHODCALLTYPE Release() throw();
```

### <a name="return-value"></a>Возвращаемое значение

Всегда возвращает 1.

### <a name="remarks"></a>Remarks

Этот класс не реализует контроль времени существования с помощью подсчета ссылок.

## <a name="cthreadpoolsetsize"></a><a name="setsize"></a>Ксреадпул:: SetSize

Вызовите этот метод, чтобы задать количество потоков в пуле.

```
HRESULT STDMETHODCALLTYPE SetSizeint nNumThreads) throw();
```

### <a name="parameters"></a>Параметры

*ннумсреадс*<br/>
Запрошенное число потоков в пуле.

Если *ннумсреадс* является отрицательным, его абсолютное значение будет умножено на число процессоров на компьютере, чтобы получить общее число потоков.

Если *ннумсреадс* равен нулю, ATLS_DEFAULT_THREADSPERPROC будут умножены на количество процессоров на компьютере, чтобы получить общее число потоков. Значение по умолчанию — 2 потока на процессор. При необходимости можно определить собственное положительное целочисленное значение для этого символа, прежде чем включать файлов atlutil. h.

### <a name="return-value"></a>Возвращаемое значение

Возвращает S_OK при успешном выполнении или ошибку HRESULT при сбое.

### <a name="remarks"></a>Remarks

Если указанное число потоков меньше, чем число потоков в пуле, объект помещает сообщение о завершении работы в очередь для появления ожидающего потока. Когда ожидающий поток извлекает сообщение из очереди, он уведомляет пул потоков и завершает процедуру потока. Этот процесс повторяется до тех пор, пока количество потоков в пуле не достигнет указанного числа или пока ни один поток не завершит работу в течение периода, [указанного параметром](#gettimeout) /  [setTimeout](#settimeout). В этом случае метод возвратит значение HRESULT, соответствующее WAIT_TIMEOUT, а ожидающее сообщение о завершении работы отменяется.

## <a name="cthreadpoolsettimeout"></a><a name="settimeout"></a>Ксреадпул:: SetTimeout

Вызовите этот метод, чтобы задать максимальное время в миллисекундах, в течение которого пул потоков будет ожидать завершения работы потока.

```
HRESULT STDMETHODCALLTYPE SetTimeout(DWORD dwMaxWait) throw();
```

### <a name="parameters"></a>Параметры

*двмаксваит*<br/>
Запрошенное максимальное время в миллисекундах, в течение которого пул потоков будет ожидать завершения работы потока.

### <a name="return-value"></a>Возвращаемое значение

Возвращает S_OK при успешном выполнении или ошибку HRESULT при сбое.

### <a name="remarks"></a>Remarks

Время ожидания инициализируется для ATLS_DEFAULT_THREADPOOLSHUTDOWNTIMEOUT. Время по умолчанию — 36 секунд. При необходимости можно определить собственное положительное целочисленное значение для этого символа, прежде чем включать файлов atlutil. h.

Обратите внимание, что *двмаксваит* — это время, в течение которого пул будет ожидать завершения работы одного потока. Максимальное время, которое можно предпринять для удаления нескольких потоков из пула, может быть немного меньше *двмаксваит* , умноженное на число потоков.

## <a name="cthreadpoolshutdown"></a><a name="shutdown"></a>Ксреадпул:: Shutdown

Вызовите этот метод, чтобы завершить работу пула потоков.

```cpp
void Shutdown(DWORD dwMaxWait = 0) throw();
```

### <a name="parameters"></a>Параметры

*двмаксваит*<br/>
Запрошенное максимальное время в миллисекундах, в течение которого пул потоков будет ожидать завершения работы потока. Если значение равно 0 или не указано, этот метод будет использовать время ожидания, установленное [ксреадпул:: setTimeout](#settimeout).

### <a name="remarks"></a>Remarks

Этот метод отправляет запрос на завершение работы во все потоки в пуле. Если время ожидания истекает, этот метод вызывает [TerminateThread](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) для любого потока, который не завершил работу. Этот метод вызывается автоматически из деструктора класса.

## <a name="see-also"></a>См. также статью

[Интерфейс Исреадпулконфиг](../../atl/reference/ithreadpoolconfig-interface.md)<br/>
[дефаултсреадтраитс](atl-typedefs.md#defaultthreadtraits)<br/>
[Классы](../../atl/reference/atl-classes.md)
